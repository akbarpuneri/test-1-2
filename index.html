<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nota Analisa Investasi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for interactive graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* Lighter blue-gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            min-height: 100vh; /* Ensure it takes full viewport height */
            padding: 2rem 0; /* Add vertical padding */
        }
        .container {
            max-width: 1200px;
            width: 95%; /* Make it slightly wider on smaller screens */
            margin: 0 auto;
            padding: 2.5rem; /* Increased padding */
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* Stronger shadow */
            border: 1px solid #cbd5e1; /* Subtle border */
        }
        .section-title {
            font-size: 1.75rem; /* Larger title */
            font-weight: 700; /* Bolder */
            color: #1a202c; /* Darker text */
            margin-bottom: 2rem; /* More space */
            border-bottom: 3px solid #3b82f6; /* Thicker, colored border */
            padding-bottom: 0.75rem;
            text-align: center;
        }
        .form-label {
            display: block;
            font-weight: 600; /* Bolder label */
            color: #2d3748; /* Darker text */
            margin-bottom: 0.6rem;
        }
        .form-input, .form-textarea {
            width: 100%;
            padding: 0.9rem; /* Increased padding */
            border: 1px solid #a0aec0; /* Darker border */
            border-radius: 0.75rem; /* More rounded */
            font-size: 1.05rem; /* Slightly larger font */
            color: #2d3748;
            background-color: #f8fafc; /* Off-white background */
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out, background-color 0.3s ease-in-out;
        }
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3); /* More prominent focus shadow */
            background-color: #ffffff;
        }
        .btn-base {
            padding: 0.9rem 2rem;
            border-radius: 0.75rem;
            font-weight: 700; /* Bolder */
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary {
            @apply bg-gradient-to-r from-blue-500 to-blue-600 text-white;
        }
        .btn-primary:hover {
            @apply from-blue-600 to-blue-700 transform -translate-y-0.5 shadow-lg;
        }
        .btn-secondary {
            @apply bg-gray-500 text-white;
        }
        .btn-secondary:hover {
            @apply bg-gray-600 transform -translate-y-0.5 shadow-lg;
        }
        .btn-success {
            @apply bg-gradient-to-r from-green-500 to-green-600 text-white;
        }
        .btn-success:hover {
            @apply from-green-600 to-green-700 transform -translate-y-0.5 shadow-lg;
        }
        .btn-danger {
            @apply bg-gradient-to-r from-red-500 to-red-600 text-white;
        }
        .btn-danger:hover {
            @apply from-red-600 to-red-700 transform -translate-y-0.5 shadow-lg;
        }
        .alert {
            padding: 1rem;
            border-radius: 0.75rem; /* More rounded */
            margin-bottom: 1.5rem; /* More space */
            font-weight: 500;
            border: 1px solid; /* Add border for better visual separation */
        }
        .alert-success {
            background-color: #d1fae5;
            color: #065f46;
            border-color: #34d399;
        }
        .alert-error {
            background-color: #fee2e2;
            color: #991b1b;
            border-color: #ef4444;
        }
        .alert-warning {
            background-color: #fffbeb;
            color: #92400e;
            border-color: #fbbf24;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2.5rem; /* More padding */
            border-radius: 1.5rem; /* More rounded */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* Stronger shadow */
            max-width: 550px; /* Slightly wider */
            width: 90%;
            text-align: center;
            transform: translateY(-20px); /* Slight animation on show */
            transition: transform 0.3s ease-in-out;
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1.25rem; /* More space between buttons */
            margin-top: 2rem;
        }

        /* Slider styles */
        .switch-toggle {
            position: relative;
            display: inline-block;
            width: 240px; /* Increased width for better text display */
            height: 48px; /* Increased height */
            background-color: #cbd5e1; /* Light gray for background */
            border-radius: 24px; /* Half of height for pill shape */
            cursor: pointer;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15); /* Inner shadow */
            transition: background-color 0.3s ease;
        }

        .switch-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-toggle .slider {
            position: absolute;
            top: 0;
            left: 0;
            width: 120px; /* Half of the total width */
            height: 100%;
            background-color: #3b82f6; /* Blue for active state */
            border-radius: 24px;
            transition: transform 0.3s ease;
            transform: translateX(0); /* Initial position for proposer */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Slider thumb shadow */
        }

        .switch-toggle input:checked + .slider {
            transform: translateX(120px); /* Move for reviewer */
        }

        .switch-toggle .labels {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center; /* Vertically center text */
            font-weight: 600;
            color: #4b5563; /* Gray for inactive text */
            z-index: 1;
        }

        .switch-toggle .labels span {
            flex: 1;
            text-align: center;
            transition: color 0.3s ease;
            user-select: none; /* Prevent text selection */
            line-height: 48px; /* Match height for perfect vertical centering */
        }

        .switch-toggle input:not(:checked) ~ .labels span:first-child {
            color: white; /* White for active proposer text */
        }

        .switch-toggle input:checked ~ .labels span:last-child {
            color: white; /* White for active reviewer text */
        }

        /* Memo card styles */
        .memo-card {
            @apply p-5 border rounded-xl shadow-md cursor-pointer transition-all duration-300 ease-in-out;
            border-left: 8px solid; /* Accent border */
        }
        .memo-card:hover {
            @apply transform -translate-y-1 scale-[1.01] shadow-lg;
        }
        .memo-card.pending {
            @apply bg-blue-50 border-blue-400;
        }
        .memo-card.pending:hover {
            @apply bg-blue-100;
        }
        .memo-card.approved {
            @apply bg-green-50 border-green-400;
        }
        .memo-card.approved:hover {
            @apply bg-green-100;
        }
        .memo-card.rejected {
            @apply bg-red-50 border-red-400;
        }
        .memo-card.rejected:hover {
            @apply bg-red-100;
        }
        .memo-card.warning {
            @apply border-orange-500 ring-2 ring-orange-300;
        }
        .memo-card.auto-sent {
            @apply border-red-600 ring-2 ring-red-400;
        }

        /* Prose styles for memo content */
        .prose h4 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: #2d3748;
        }
        .prose ul {
            list-style: disc;
            margin-left: 1.25rem;
            padding-left: 0;
        }
        .prose li {
            margin-bottom: 0.25rem;
        }
        .prose p {
            margin-bottom: 0.75rem;
        }
        .comment-box {
            @apply bg-gray-100 p-4 rounded-lg border border-gray-200 shadow-sm;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Sistem Nota Analisa Investasi</h1>

        <div class="flex justify-center gap-4 mb-8">
            <label class="switch-toggle">
                <input type="checkbox" id="view-switcher">
                <span class="slider"></span>
                <div class="labels">
                    <span>Pengusul</span>
                    <span>Peninjau</span>
                </div>
            </label>
        </div>

        <!-- Bagian Pengusul -->
        <div id="proposer-view" class="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
            <h2 class="section-title">Buat Nota Analisa Investasi</h2>
            <div id="proposer-message-box" class="alert hidden"></div>

            <form id="memo-form" class="space-y-6">
                <div>
                    <label for="proposer-name" class="form-label">Nama Pengusul:</label>
                    <input type="text" id="proposer-name" class="form-input" placeholder="Misal: PT. Anak Perusahaan A" required>
                </div>

                <!-- Aspek Finansial / Bisnis (dari CSV) -->
                <div>
                    <label for="financial-csv" class="form-label">Aspek Finansial / Bisnis (Unggah File CSV):</label>
                    <input type="file" id="financial-csv" accept=".csv" class="form-input p-2" required>
                    <div id="financial-data-preview" class="mt-2 p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700 hidden">
                        <p class="font-semibold mb-1">Data Finansial Terunggah:</p>
                        <pre id="financial-data-content" class="whitespace-pre-wrap"></pre>
                    </div>
                </div>

                <!-- Aspek Kajian Lainnya (Manual Input) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="kepentingan-objektivitas" class="form-label">2. Kepentingan / Objektivitas / Tujuan:</label>
                        <textarea id="kepentingan-objektivitas" class="form-textarea" rows="3" placeholder="Penjelasan singkat sesuai dengan kajian aspek Kepentingan/Objektivitas/Tujuan..." required></textarea>
                    </div>
                    <div>
                        <label for="lingkungan-sosial-ekonomi" class="form-label">3. Lingkungan, Sosial, dan Ekonomi:</label>
                        <textarea id="lingkungan-sosial-ekonomi" class="form-textarea" rows="3" placeholder="Penjelasan singkat sesuai dengan kajian aspek Sosial dan Ekonomi..." required></textarea>
                    </div>
                    <div>
                        <label for="fiskal" class="form-label">4. Fiskal:</label>
                        <textarea id="fiskal" class="form-textarea" rows="3" placeholder="Penjelasan singkat sesuai dengan kajian aspek Fiskal..." required></textarea>
                    </div>
                    <div>
                        <label for="pelayanan-operasional" class="form-label">5. Pelayanan dan Operasional:</label>
                        <textarea id="pelayanan-operasional" class="form-textarea" rows="3" placeholder="Diisi sesuai dengan penjelasan pada kajian / lampiran..." required></textarea>
                    </div>
                    <div>
                        <label for="legal" class="form-label">6. Legal:</label>
                        <textarea id="legal" class="form-textarea" rows="3" placeholder="Diisi sesuai dengan penjelasan pada kajian / lampiran..." required></textarea>
                    </div>
                    <div>
                        <label for="manajemen-risiko" class="form-label">7. Manajemen Risiko:</label>
                        <textarea id="manajemen-risiko" class="form-textarea" rows="3" placeholder="Diisi sesuai dengan penjelasan pada kajian / lampiran..." required></textarea>
                    </div>
                    <div>
                        <label for="corporate-governance" class="form-label">8. Corporate Governance & Compliance:</label>
                        <textarea id="corporate-governance" class="form-textarea" rows="3" placeholder="Diisi sesuai dengan penjelasan pada kajian / lampiran..." required></textarea>
                    </div>
                    <div>
                        <label for="aspek-lainnya" class="form-label">9. Aspek Lainnya:</label>
                        <textarea id="aspek-lainnya" class="form-textarea" rows="3" placeholder="Dapat diusulkan parameter terkait aspek lainnya oleh Unit Terkait lainnya..." required></textarea>
                    </div>
                </div>

                <button type="submit" class="btn-base btn-primary w-full mt-6">Buat Nota Analisa Investasi</button>
            </form>

            <div id="generated-memo-preview" class="mt-8 p-6 bg-gray-50 rounded-xl border border-gray-200 hidden">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Pratinjau Nota Analisa Investasi</h3>
                <div id="memo-content" class="prose max-w-none text-gray-700">
                    <!-- Memo content will be rendered here -->
                </div>
                <h4 class="text-lg font-semibold mt-6 mb-2">Visualisasi Data Finansial:</h4>
                <div class="relative h-64 w-full bg-white p-4 rounded-lg shadow-inner">
                    <canvas id="proposerFinancialChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Bagian Peninjau -->
        <div id="reviewer-view" class="p-6 bg-white rounded-xl shadow-lg border border-gray-200 hidden">
            <h2 class="section-title">Daftar Nota untuk Ditinjau</h2>
            <div id="reviewer-message-box" class="alert hidden"></div>

            <div id="memo-list" class="space-y-4">
                <!-- Daftar memo akan dimuat di sini -->
                <p class="text-gray-500 text-center" id="no-memo-message">Belum ada nota yang diajukan untuk ditinjau.</p>
            </div>

            <!-- Detail Memo Peninjau -->
            <div id="reviewer-memo-detail" class="mt-8 p-6 bg-gray-50 rounded-xl border border-gray-200 hidden">
                <button id="back-to-list-btn" class="btn-base btn-secondary mb-4">‚Üê Kembali ke Daftar Nota</button>
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Detail Nota Analisa Investasi</h3>
                <div id="current-memo-display" class="prose max-w-none text-gray-700 mb-6">
                    <!-- Detail memo akan dimuat di sini -->
                </div>
                <h4 class="text-lg font-semibold mt-6 mb-2">Visualisasi Data Finansial:</h4>
                <div class="relative h-64 w-full bg-white p-4 rounded-lg shadow-inner">
                    <canvas id="reviewerFinancialChart"></canvas>
                </div>

                <div class="space-y-4 mt-6">
                    <div>
                        <label for="reviewer-comment" class="form-label">Komentar Peninjau:</label>
                        <textarea id="reviewer-comment" class="form-textarea" rows="4" placeholder="Tambahkan komentar Anda di sini..."></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button id="submit-comment-btn" class="btn-base btn-primary flex-1">Kirim Komentar</button>
                        <button id="approve-memo-btn" class="btn-base btn-success flex-1">Setujui</button>
                        <button id="reject-memo-btn" class="btn-base btn-danger flex-1">Tolak</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Alerts/Confirmations -->
    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-semibold mb-4 text-gray-800"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <div id="modal-buttons" class="modal-buttons">
                <!-- Buttons will be injected here -->
            </div>
        </div>
    </div>

    <script>
        // Global state for memos
        let memos = JSON.parse(localStorage.getItem('investmentMemos')) || [];
        let currentFinancialData = null;
        let currentMemoId = null; // To keep track of the memo being reviewed
        let proposerChartInstance = null; // To store Chart.js instance for proposer view
        let reviewerChartInstance = null; // To store Chart.js instance for reviewer view

        // DOM Elements
        const proposerView = document.getElementById('proposer-view');
        const reviewerView = document.getElementById('reviewer-view');
        const viewSwitcher = document.getElementById('view-switcher'); // The new slider checkbox
        const memoForm = document.getElementById('memo-form');
        const financialCsvInput = document.getElementById('financial-csv');
        const financialDataPreview = document.getElementById('financial-data-preview');
        const financialDataContent = document.getElementById('financial-data-content');
        const generatedMemoPreview = document.getElementById('generated-memo-preview');
        const memoContentDiv = document.getElementById('memo-content');
        const memoListDiv = document.getElementById('memo-list');
        const reviewerMemoDetailDiv = document.getElementById('reviewer-memo-detail');
        const backToListBtn = document.getElementById('back-to-list-btn');
        const currentMemoDisplay = document.getElementById('current-memo-display');
        const reviewerCommentInput = document.getElementById('reviewer-comment');
        const submitCommentBtn = document.getElementById('submit-comment-btn');
        const approveMemoBtn = document.getElementById('approve-memo-btn');
        const rejectMemoBtn = document.getElementById('reject-memo-btn');
        const noMemoMessage = document.getElementById('no-memo-message');

        const proposerMessageBox = document.getElementById('proposer-message-box');
        const reviewerMessageBox = document.getElementById('reviewer-message-box');

        // Modal Elements
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalButtons = document.getElementById('modal-buttons');

        // --- Utility Functions ---

        function showModal(title, message, buttons) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = ''; // Clear previous buttons

            buttons.forEach(button => {
                const btn = document.createElement('button');
                btn.textContent = button.text;
                btn.className = `btn-base ${button.className || 'btn-primary'}`; // Use btn-base
                btn.onclick = () => {
                    hideModal();
                    if (button.handler) button.handler();
                };
                modalButtons.appendChild(btn);
            });
            customModal.classList.add('show');
        }

        function hideModal() {
            customModal.classList.remove('show');
        }

        function displayMessage(element, message, type) {
            element.textContent = message;
            element.className = `alert ${type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-warning'}`;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        function saveMemos() {
            localStorage.setItem('investmentMemos', JSON.stringify(memos));
        }

        function generateUniqueId() {
            return 'memo-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // Function to parse CSV data
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return {};

            const result = {};
            lines.forEach(line => {
                const parts = line.split(',');
                if (parts.length >= 2) {
                    const key = parts[0].trim();
                    let value = parts.slice(1).join(',').trim(); // Join remaining parts for value

                    // Attempt to parse numerical values, handling commas and percentage signs
                    if (!isNaN(parseFloat(value.replace(/,/g, '')))) {
                        value = parseFloat(value.replace(/,/g, ''));
                        if (value.toString().endsWith('%')) { // If it was originally a percentage string
                             value = value / 100; // Convert to decimal
                        }
                    } else if (value.endsWith('%')) { // Handle cases like "10%"
                        value = parseFloat(value.slice(0, -1).replace(/,/g, '')) / 100;
                    }
                    result[key] = value;
                }
            });
            return result;
        }

        // Function to format date for display
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }

        // --- Charting Functionality ---
        function renderFinancialChart(canvasId, financialData, chartInstance) {
            const ctx = document.getElementById(canvasId);

            // Destroy existing chart instance if it exists
            if (chartInstance) {
                chartInstance.destroy();
            }

            // Extract relevant financial metrics for the chart
            const labels = [];
            const data = [];
            const backgroundColors = [];
            const borderColors = [];

            const metricsToChart = {
                'EBITDA Margin': 'rgba(75, 192, 192, 0.7)', /* Teal */
                'Net Profit Margin': 'rgba(153, 102, 255, 0.7)', /* Purple */
                'ROE': 'rgba(255, 159, 64, 0.7)', /* Orange */
                'ROA': 'rgba(54, 162, 235, 0.7)', /* Blue */
                'Current Ratio': 'rgba(255, 99, 132, 0.7)', /* Red */
                'Liquidity Buffer': 'rgba(201, 203, 207, 0.7)', /* Gray */
                'IBD to Invested Capital': 'rgba(255, 205, 86, 0.7)', /* Yellow */
                'DSCR': 'rgba(75, 192, 192, 0.7)', /* Teal (re-use) */
                'Economic profit': 'rgba(192, 75, 192, 0.7)', /* Pink */
                'NPV': 'rgba(54, 162, 235, 0.7)', /* Blue (re-use) */
                'IRR': 'rgba(153, 102, 255, 0.7)' /* Purple (re-use) */
            };

            for (const metric in metricsToChart) {
                if (financialData[metric] !== undefined && financialData[metric] !== null) {
                    let value = financialData[metric];
                    // Ensure value is a number
                    if (typeof value === 'string') {
                        value = parseFloat(value.replace(/,/g, ''));
                        if (value.toString().endsWith('%')) { // If it was originally a percentage string
                             value = value / 100; // Convert to decimal
                        }
                    }

                    if (!isNaN(value)) {
                        labels.push(metric);
                        data.push(value);
                        backgroundColors.push(metricsToChart[metric]);
                        borderColors.push(metricsToChart[metric].replace('0.7', '1')); // Opaque border
                    }
                }
            }

            if (labels.length === 0) {
                ctx.style.display = 'none'; // Hide canvas if no data
                return null;
            } else {
                ctx.style.display = 'block';
            }

            const newChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nilai Metrik Finansial',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Nilai'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Ringkasan Metrik Finansial Utama',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#2d3748'
                        }
                    }
                }
            });
            return newChartInstance;
        }


        // --- Proposer View Logic ---

        financialCsvInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                currentFinancialData = null;
                financialDataPreview.classList.add('hidden');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csvText = e.target.result;
                    currentFinancialData = parseCSV(csvText);
                    financialDataContent.textContent = JSON.stringify(currentFinancialData, null, 2);
                    financialDataPreview.classList.remove('hidden');
                    displayMessage(proposerMessageBox, 'File CSV berhasil diunggah dan diproses.', 'success');
                } catch (error) {
                    displayMessage(proposerMessageBox, 'Gagal memproses file CSV: ' + error.message, 'error');
                    currentFinancialData = null;
                    financialDataPreview.classList.add('hidden');
                }
            };
            reader.readAsText(file);
        });

        memoForm.addEventListener('submit', (event) => {
            event.preventDefault();

            // Validate all fields are filled
            const formInputs = memoForm.querySelectorAll('.form-input, .form-textarea');
            let allFieldsFilled = true;
            formInputs.forEach(input => {
                if (!input.value.trim() && input.required) { // Check only required fields
                    allFieldsFilled = false;
                    input.classList.add('border-red-500'); // Highlight empty fields
                } else {
                    input.classList.remove('border-red-500');
                }
            });

            if (!currentFinancialData || Object.keys(currentFinancialData).length === 0) {
                allFieldsFilled = false;
                financialCsvInput.classList.add('border-red-500');
                displayMessage(proposerMessageBox, 'Harap unggah file CSV finansial yang valid.', 'error');
            } else {
                financialCsvInput.classList.remove('border-red-500');
            }

            if (!allFieldsFilled) {
                displayMessage(proposerMessageBox, 'Harap lengkapi semua bidang yang wajib diisi.', 'error');
                return;
            }

            const proposerName = document.getElementById('proposer-name').value;
            const submissionDate = new Date();
            const reviewDeadline = new Date(submissionDate);
            reviewDeadline.setDate(submissionDate.getDate() + 3); // 3 days for warning
            const autoSendDate = new Date(submissionDate);
            autoSendDate.setDate(submissionDate.getDate() + 5); // 5 days for auto-send

            const newMemo = {
                id: generateUniqueId(),
                proposerName: proposerName,
                submissionDate: submissionDate.toISOString(),
                status: 'pending', // 'pending', 'approved', 'rejected'
                financialData: currentFinancialData,
                aspects: {
                    kepentingan: document.getElementById('kepentingan-objektivitas').value,
                    lingkungan: document.getElementById('lingkungan-sosial-ekonomi').value,
                    fiskal: document.getElementById('fiskal').value,
                    pelayanan: document.getElementById('pelayanan-operasional').value,
                    legal: document.getElementById('legal').value,
                    manajemenRisiko: document.getElementById('manajemen-risiko').value,
                    corporateGovernance: document.getElementById('corporate-governance').value,
                    aspekLainnya: document.getElementById('aspek-lainnya').value
                },
                reviewerComments: [], // Can be extended to include multiple reviewers
                reviewDeadline: reviewDeadline.toISOString(),
                autoSendDate: autoSendDate.toISOString(),
                lastReviewCheck: submissionDate.toISOString(), // To track when last checked for warnings/auto-send
                autoSent: false // Flag to prevent repeated auto-send notifications
            };

            memos.push(newMemo);
            saveMemos();
            renderMemoPreview(newMemo);
            displayMessage(proposerMessageBox, 'Nota Analisa Investasi berhasil dibuat dan diajukan!', 'success');
            memoForm.reset(); // Clear form
            currentFinancialData = null;
            financialDataPreview.classList.add('hidden');
        });

        function renderMemoPreview(memo) {
            let financialHtml = '<ul>';
            for (const key in memo.financialData) {
                // Display numbers formatted nicely, e.g., with 2 decimal places or as percentages
                let displayValue = memo.financialData[key];
                if (typeof displayValue === 'number') {
                    if (key.includes('Margin') || key.includes('ROE') || key.includes('ROA') || key.includes('IRR')) {
                        displayValue = (displayValue * 100).toFixed(2) + '%'; // Format as percentage
                    } else if (key.includes('NPV') || key.includes('Economic profit')) {
                        displayValue = 'Rp ' + displayValue.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 2 }); // Format as IDR
                    } else {
                        displayValue = displayValue.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
                    }
                }
                financialHtml += `<li><strong>${key}:</strong> ${displayValue}</li>`;
            }
            financialHtml += '</ul>';

            memoContentDiv.innerHTML = `
                <p class="mb-2"><strong class="text-gray-700">Nama Pengusul:</strong> ${memo.proposerName}</p>
                <p class="mb-2"><strong class="text-gray-700">Tanggal Pengajuan:</strong> ${formatDate(memo.submissionDate)}</p>
                <p class="mb-4"><strong class="text-gray-700">Status:</strong> <span class="font-semibold text-blue-600">${memo.status.toUpperCase()}</span></p>
                <h4 class="text-lg font-semibold mt-4 mb-2">1. Finansial / Bisnis:</h4>
                ${financialHtml}
                <h4 class="text-lg font-semibold mt-4 mb-2">2. Kepentingan / Objektivitas / Tujuan:</h4>
                <p>${memo.aspects.kepentingan}</p>
                <h4 class="text-lg font-semibold mt-4 mb-2">3. Lingkungan, Sosial, dan Ekonomi:</h4>
                <p>${memo.aspects.lingkungan}</p>
                <h4 class="text-lg font-semibold mt-4 mb-2">4. Fiskal:</h4>
                <p>${memo.aspects.fiskal}</p>
                <h4 class="text-lg font-semibold mt-4 mb-2">5. Pelayanan dan Operasional:</h4>
                <p>${memo.aspects.pelayanan}</p>
                <h4 class="text-lg font-semibold mt-4 mb-2">6. Legal:</h4>
                <p>${memo.aspects.legal}</p>
                <h4 class="text-lg font-semibold mt-4 mb-2">7. Manajemen Risiko:</h4>
                <p>${memo.aspects.manajemenRisiko}</p>
                <h4 class="text-lg font-semibold mt-4 mb-2">8. Corporate Governance & Compliance:</h4>
                <p>${memo.aspects.corporateGovernance}</p>
                <h4 class="text-lg font-semibold mt-4 mb-2">9. Aspek Lainnya:</h4>
                <p>${memo.aspects.aspekLainnya}</p>
            `;
            generatedMemoPreview.classList.remove('hidden');

            // Render chart for proposer view
            proposerChartInstance = renderFinancialChart('proposerFinancialChart', memo.financialData, proposerChartInstance);
        }

        // --- Reviewer View Logic ---

        function renderReviewerList() {
            memoListDiv.innerHTML = ''; // Clear existing list
            reviewerMemoDetailDiv.classList.add('hidden'); // Hide detail view when showing list

            if (memos.length === 0) {
                noMemoMessage.classList.remove('hidden');
                return;
            } else {
                noMemoMessage.classList.add('hidden');
            }

            memos.forEach(memo => {
                const now = new Date();
                const reviewDeadline = new Date(memo.reviewDeadline);
                const autoSendDate = new Date(memo.autoSendDate);

                let statusText = `<span class="font-semibold text-blue-600">${memo.status.toUpperCase()}</span>`;
                let cardClasses = `memo-card ${memo.status}`; // Base classes
                let notificationMessage = '';

                if (memo.status === 'pending') {
                    if (now > autoSendDate) {
                        statusText = `<span class="font-semibold text-red-600">OTOMATIS DIKIRIM (Belum Ditinjau)</span>`;
                        cardClasses += ' auto-sent'; // Stronger highlight
                        if (!memo.autoSent) { // Trigger notification only once
                            notificationMessage = `Nota "${memo.proposerName}" (ID: ${memo.id.substring(0, 8)}) otomatis dikirim kembali ke pengusul karena belum ditinjau setelah 5 hari.`;
                            memo.autoSent = true; // Mark as auto-sent
                            saveMemos();
                        }
                    } else if (now > reviewDeadline) {
                        statusText = `<span class="font-semibold text-orange-600">PERINGATAN (Lewat 3 Hari)</span>`;
                        cardClasses += ' warning'; // Highlight
                        notificationMessage = `Peringatan: Nota "${memo.proposerName}" (ID: ${memo.id.substring(0, 8)}) telah melewati batas waktu 3 hari peninjauan.`;
                    }
                }

                if (notificationMessage) {
                    displayMessage(reviewerMessageBox, notificationMessage, 'warning');
                }

                const memoCard = document.createElement('div');
                memoCard.className = cardClasses;

                memoCard.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-800 mb-1">${memo.proposerName}</h4>
                    <p class="text-sm text-gray-600 mb-0.5">Diajukan: ${formatDate(memo.submissionDate)}</p>
                    <p class="text-sm text-gray-600 mb-0.5">ID Nota: ${memo.id.substring(0, 10)}...</p>
                    <p class="text-sm text-gray-600">Status: ${statusText}</p>
                `;
                memoCard.addEventListener('click', () => viewMemoDetails(memo.id));
                memoListDiv.appendChild(memoCard);
            });
        }

        function viewMemoDetails(memoId) {
            currentMemoId = memoId;
            const memo = memos.find(m => m.id === memoId);
            if (!memo) {
                displayMessage(reviewerMessageBox, 'Nota tidak ditemukan.', 'error');
                return;
            }

            let financialHtml = '<ul>';
            for (const key in memo.financialData) {
                // Display numbers formatted nicely, e.g., with 2 decimal places or as percentages
                let displayValue = memo.financialData[key];
                if (typeof displayValue === 'number') {
                    if (key.includes('Margin') || key.includes('ROE') || key.includes('ROA') || key.includes('IRR')) {
                        displayValue = (displayValue * 100).toFixed(2) + '%'; // Format as percentage
                    } else if (key.includes('NPV') || key.includes('Economic profit')) {
                        displayValue = 'Rp ' + displayValue.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 2 }); // Format as IDR
                    } else {
                        displayValue = displayValue.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
                    }
                }
                financialHtml += `<li><strong>${key}:</strong> ${displayValue}</li>`;
            }
            financialHtml += '</ul>';

            let commentsHtml = '';
            if (memo.reviewerComments.length > 0) {
                commentsHtml = '<h4 class="text-lg font-semibold mt-6 mb-2">Komentar Peninjau:</h4>';
                memo.reviewerComments.forEach(comment => {
                    commentsHtml += `
                        <div class="comment-box">
                            <p class="text-sm font-semibold text-gray-800">${comment.reviewerId} pada ${formatDate(comment.date)}:</p>
                            <p class="text-gray-700">${comment.comment}</p>
                        </div>
                    `;
                });
            } else {
                commentsHtml = '<p class="text-gray-500 mt-4">Belum ada komentar.</p>';
            }

            currentMemoDisplay.innerHTML = `
                <p class="mb-2"><strong class="text-gray-700">Nama Pengusul:</strong> ${memo.proposerName}</p>
                <p class="mb-2"><strong class="text-gray-700">Tanggal Pengajuan:</strong> ${formatDate(memo.submissionDate)}</p>
                <p class="mb-4"><strong class="text-gray-700">Status:</strong> <span class="font-semibold text-blue-600">${memo.status.toUpperCase()}</span></p>
                <h4 class="text-lg font-semibold mt-4 mb-2">1. Finansial / Bisnis:</h4>
                ${financialHtml}
                <h4 class="text-lg font-semibold mt-4 mb-2">2. Kepentingan / Objektivitas / Tujuan:</h4>
                <p>${memo.aspects.kepentingan}</p>
                <h4 class="text-lg font-semibold mt-4 mb-2">3. Lingkungan, Sosial, dan Ekonomi:</h4>
                <p>${memo.aspects.lingkungan}</p>
                <h4 class="text-lg font-semibold mt-4 mb-2">4. Fiskal:</h4>
                <p>${memo.aspects.fiskal}</p>
                <h4 class="text-lg font-semibold mt-4 mb-2">5. Pelayanan dan Operasional:</h4>
                <p>${memo.aspects.pelayanan}</p>
                <h4 class="text-lg font-semibold mt-4 mb-2">6. Legal:</h4>
                <p>${memo.aspects.legal}</p>
                <h4 class="text-lg font-semibold mt-4 mb-2">7. Manajemen Risiko:</h4>
                <p>${memo.aspects.manajemenRisiko}</p>
                <h4 class="text-lg font-semibold mt-4 mb-2">8. Corporate Governance & Compliance:</h4>
                <p>${memo.aspects.corporateGovernance}</p>
                <h4 class="text-lg font-semibold mt-4 mb-2">9. Aspek Lainnya:</h4>
                <p>${memo.aspects.aspekLainnya}</p>
                ${commentsHtml}
            `;

            reviewerMemoDetailDiv.classList.remove('hidden');
            // Render chart for reviewer view
            reviewerChartInstance = renderFinancialChart('reviewerFinancialChart', memo.financialData, reviewerChartInstance);
        }

        submitCommentBtn.addEventListener('click', () => {
            const commentText = reviewerCommentInput.value.trim();
            if (!commentText) {
                displayMessage(reviewerMessageBox, 'Komentar tidak boleh kosong.', 'warning');
                return;
            }

            const memoIndex = memos.findIndex(m => m.id === currentMemoId);
            if (memoIndex > -1) {
                // For simplicity, using a generic reviewer ID. In a real app, this would be authenticated user ID.
                const reviewerId = 'Peninjau_1';
                memos[memoIndex].reviewerComments.push({
                    reviewerId: reviewerId,
                    comment: commentText,
                    date: new Date().toISOString()
                });
                saveMemos();
                displayMessage(reviewerMessageBox, 'Komentar berhasil ditambahkan.', 'success');
                reviewerCommentInput.value = ''; // Clear comment field
                viewMemoDetails(currentMemoId); // Re-render details to show new comment
            }
        });

        approveMemoBtn.addEventListener('click', () => {
            showModal('Konfirmasi Persetujuan', 'Apakah Anda yakin ingin menyetujui nota ini?', [
                { text: 'Ya, Setujui', className: 'btn-success', handler: () => updateMemoStatus('approved') },
                { text: 'Batal', className: 'btn-secondary' }
            ]);
        });

        rejectMemoBtn.addEventListener('click', () => {
            showModal('Konfirmasi Penolakan', 'Apakah Anda yakin ingin menolak nota ini?', [
                { text: 'Ya, Tolak', className: 'btn-danger', handler: () => updateMemoStatus('rejected') },
                { text: 'Batal', className: 'btn-secondary' }
            ]);
        });

        function updateMemoStatus(status) {
            const memoIndex = memos.findIndex(m => m.id === currentMemoId);
            if (memoIndex > -1) {
                memos[memoIndex].status = status;
                saveMemos();
                displayMessage(reviewerMessageBox, `Nota berhasil ${status === 'approved' ? 'disetujui' : 'ditolak'}.`, 'success');
                renderReviewerList(); // Go back to list and refresh
                reviewerMemoDetailDiv.classList.add('hidden');
            }
        }

        backToListBtn.addEventListener('click', () => {
            renderReviewerList();
            reviewerMemoDetailDiv.classList.add('hidden');
        });

        // --- View Switching Logic ---

        function showView(viewName) {
            proposerView.classList.add('hidden');
            reviewerView.classList.add('hidden');

            // Disable/enable form fields based on view
            const formInputs = memoForm.querySelectorAll('input, textarea, button[type="submit"]');
            if (viewName === 'proposer') {
                proposerView.classList.remove('hidden');
                formInputs.forEach(input => input.removeAttribute('disabled'));
            } else if (viewName === 'reviewer') {
                reviewerView.classList.remove('hidden');
                formInputs.forEach(input => input.setAttribute('disabled', 'true'));
                renderReviewerList(); // Refresh reviewer list when entering view
            }
        }

        // Event listener for the slider
        viewSwitcher.addEventListener('change', (event) => {
            if (event.target.checked) {
                // Checked means Reviewer
                showView('reviewer');
            } else {
                // Unchecked means Proposer
                showView('proposer');
            }
        });

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial state of the slider and view
            viewSwitcher.checked = false; // Default to Proposer
            showView('proposer');

            // Periodically check for review deadlines (simplified for client-side app)
            // This interval will trigger renderReviewerList, which handles notifications
            setInterval(renderReviewerList, 10 * 1000); // Check every 10 seconds for demo purposes
        });
    </script>
</body>
</html>
