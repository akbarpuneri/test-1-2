<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kerangka Kerja Analisis CapEx Interaktif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs - Only for Firestore operations, Authentication removed -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment (only appId is relevant now)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        let app, db;
        // userRole and currentUserId will be managed by the slider and derived from it
        window.userRole = 'proposer'; // Default initial role
        window.currentUserId = 'proposer_simulated_user'; // Default initial user ID

        // Initialize Firebase Firestore only
        window.onload = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);

                // Expose to global scope for use in main script
                window.firebaseApp = app;
                window.firebaseDb = db;
                window.firebaseAppId = appId; // Make appId globally available
                window.firebaseServerTimestamp = serverTimestamp; // Expose serverTimestamp globally
                // Expose Firestore functions to global scope
                window.firebaseCollection = collection;
                window.firebaseDoc = doc;
                window.firebaseGetDoc = getDoc;
                window.firebaseAddDoc = addDoc;
                window.firebaseSetDoc = setDoc;
                window.firebaseUpdateDoc = updateDoc;
                window.firebaseDeleteDoc = deleteDoc;
                window.firebaseOnSnapshot = onSnapshot;
                window.firebaseQuery = query;
                window.firebaseWhere = where;

                // Initialize app components after Firestore is ready
                // The slider will trigger initAppComponents based on its value
                const roleSlider = document.getElementById('role-slider');
                updateRoleAndUI(parseInt(roleSlider.value)); // Set initial UI based on default slider value
                
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                // No auth-status element now, but log to console or display in a message box if needed.
            }
        };
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            color: #1e293b; /* slate-800 */
        }
        .nav-link {
            transition: color 0.3s, border-bottom-color 0.3s;
            border-bottom: 2px solid transparent;
        }
        .nav-link:hover, .nav-link.active {
            color: #2563eb; /* blue-600 */
            border-bottom-color: #2563eb;
        }
        .section-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .section-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 320px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .risk-matrix-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr); /* 1 for label + 5 for impact scores */
            grid-template-rows: repeat(6, 1fr); /* 1 for label + 5 for likelihood scores */
            gap: 0.5rem;
            aspect-ratio: 1/1;
            max-width: 500px;
            margin: 0 auto; /* Center the grid */
        }
        .risk-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        .risk-cell.highlight {
            transform: scale(1.1);
            z-index: 10;
            border: 2px solid #1e293b;
        }
        .tab-button.active {
            border-color: #2563eb;
            color: #2563eb;
            background-color: #eff6ff;
        }
        .memo-status-pending { background-color: #fef08a; color: #b45309; } /* yellow-200, amber-700 */
        .memo-status-reviewed { background-color: #d1fae5; color: #065f46; } /* green-100, emerald-800 */
        .memo-status-overdue { background-color: #fecaca; color: #b91c1c; } /* red-200, red-700 */
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">

    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-30 shadow-sm">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex-shrink-0">
                    <h1 class="text-xl font-bold text-slate-800">Perangkat Analisis CapEx</h1>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <!-- Navigation links - visibility controlled by JS based on role -->
                        <a href="#data-upload" class="nav-link px-3 py-2 text-sm font-medium text-slate-600">Unggah Data</a>
                        <a href="#lifecycle" class="nav-link px-3 py-2 text-sm font-medium text-slate-600">Siklus Hidup</a>
                        <a href="#components" class="nav-link px-3 py-2 text-sm font-medium text-slate-600">Komponen</a>
                        <a href="#evaluation" class="nav-link px-3 py-2 text-sm font-medium text-slate-600">Evaluasi</a>
                        <a href="#risk" class="nav-link px-3 py-2 text-sm font-medium text-slate-600">Risiko</a>
                        <a href="#memo-generation" class="nav-link px-3 py-2 text-sm font-medium text-slate-600">Buat Memo</a>
                        <a href="#committee-dashboard" class="nav-link px-3 py-2 text-sm font-medium text-slate-600">Dasbor</a>
                        <a href="#memos" class="nav-link px-3 py-2 text-sm font-medium text-slate-600">Memo untuk Ditinjau</a>
                        <a href="#schema" class="nav-link px-3 py-2 text-sm font-medium text-slate-600">Skema Data</a>
                    </div>
                </div>
                <div class="text-sm text-slate-600 flex items-center space-x-2">
                    <span id="auth-status">Peran Saat Ini: Proposer</span>
                    <label for="role-slider" class="sr-only">Pilih Peran Pengguna</label>
                    <input type="range" id="role-slider" min="0" max="1" value="0" class="w-24 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12 flex-grow">

        <!-- No login section needed anymore -->

        <div id="app-content">
            <section id="intro" class="text-center mb-16">
                <h2 class="text-3xl md:text-4xl font-bold tracking-tight text-slate-900 mb-4">Kerangka Kerja Interaktif untuk Analisis Belanja Modal</h2>
                <p class="max-w-3xl mx-auto text-lg text-slate-600">Aplikasi ini menerjemahkan prinsip-prinsip analisis CapEx yang kuat ke dalam pengalaman interaktif. Unggah data CSV Anda untuk menjelajahi komponen-komponen utama, mengevaluasi proyek dengan metrik keuangan langsung, membuat memo investasi bertenaga AI, dan mengelola proses peninjauan.</p>
            </section>

            <!-- Proposer View -->
            <div id="proposer-view" class="hidden">
                <section id="data-upload" class="mb-20">
                    <div class="text-center mb-10">
                        <h3 class="text-2xl font-bold text-slate-800">Unggah Data Anda</h3>
                        <p class="mt-2 text-md text-slate-500">Untuk memulai, harap unggah file CSV yang diperlukan. Pastikan CSV Anda sesuai dengan header kolom yang ditentukan.</p>
                    </div>
                    <div class="section-card p-6 grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div>
                            <label for="operatingAssetCsv" class="block text-sm font-medium text-slate-700 mb-2">1. Data Aset Operasional (CSV)</label>
                            <input type="file" id="operatingAssetCsv" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                            <p class="text-xs text-slate-500 mt-2">Kolom yang diharapkan: <code class="font-mono">Year,Operating_Revenue,Operating_Expenses</code></p>
                        </div>
                        <div>
                            <label for="projectionCsv" class="block text-sm font-medium text-slate-700 mb-2">2. Proyeksi Keuangan (CSV)</label>
                            <input type="file" id="projectionCsv" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                            <p class="text-xs text-slate-500 mt-2">Kolom yang diharapkan: <code class="font-mono">Year,Projected_Revenue,Projected_Operating_Costs</code></p>
                        </div>
                        <div>
                            <label for="cashflowCsv" class="block text-sm font-medium text-slate-700 mb-2">3. Arus Kas untuk NPV/IRR (CSV)</label>
                            <input type="file" id="cashflowCsv" accept=".csv" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                            <p class="text-xs text-slate-500 mt-2">Kolom yang diharapkan: <code class="font-mono">Year,Cash_Flow</code> (Tahun 0 harus investasi awal)</p>
                        </div>
                        <div class="md:col-span-2 lg:col-span-3 flex justify-center mt-4">
                            <button id="loadDataBtn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">Muat Semua Data</button>
                        </div>
                        <div id="uploadStatus" class="md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-slate-600"></div>
                    </div>
                </section>

                <section id="lifecycle" class="mb-20">
                    <div class="text-center mb-10">
                        <h3 class="text-2xl font-bold text-slate-800">Siklus Hidup CapEx</h3>
                        <p class="mt-2 text-md text-slate-500">Dari ide awal hingga evaluasi akhir, belanja modal mengikuti proses yang terstruktur. Klik pada tahap mana pun di bawah ini untuk melompat ke bagian detail.</p>
                    </div>
                    <div class="relative flex flex-col md:flex-row items-center justify-center gap-4 md:gap-0">
                        <a href="#components" class="p-4 bg-white rounded-lg shadow-md text-center w-48 hover:shadow-xl transition-shadow">
                            <div class="text-4xl">🏢</div>
                            <h4 class="font-semibold mt-2">1. Komponen Inti</h4>
                            <p class="text-xs text-slate-500">Aset Operasional & Proyek Baru</p>
                        </a>
                        <div class="text-2xl text-slate-400 mx-4 hidden md:block">→</div>
                         <div class="2xl text-slate-400 my-2 md:hidden">↓</div>
                        <a href="#evaluation" class="p-4 bg-white rounded-lg shadow-md text-center w-48 hover:shadow-xl transition-shadow">
                            <div class="text-4xl">📈</div>
                            <h4 class="font-semibold mt-2">2. Proyeksi Keuangan</h4>
                            <p class="text-xs text-slate-500">Memproyeksikan Kinerja Masa Depan</p>
                        </a>
                        <div class="2xl text-slate-400 mx-4 hidden md:block">→</div>
                        <div class="2xl text-slate-400 my-2 md:hidden">↓</div>
                        <a href="#evaluation" class="p-4 bg-white rounded-lg shadow-md text-center w-48 hover:shadow-xl transition-shadow">
                            <div class="text-4xl">⚖️</div>
                            <h4 class="font-semibold mt-2">3. Mesin Evaluasi</h4>
                            <p class="text-xs text-slate-500">Metrik seperti NPV & IRR</p>
                        </a>
                         <div class="text-2xl text-slate-400 mx-4 hidden md:block">→</div>
                         <div class="2xl text-slate-400 my-2 md:hidden">↓</div>
                         <a href="#risk" class="p-4 bg-white rounded-lg shadow-md text-center w-48 hover:shadow-xl transition-shadow">
                            <div class="text-4xl">⚠️</div>
                            <h4 class="font-semibold mt-2">4. Penilaian Risiko</h4>
                            <p class="text-xs text-slate-500">Mengukur Ketidakpastian</p>
                        </a>
                    </div>
                </section>

                <section id="components" class="mb-20 space-y-12">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-slate-800">Komponen Inti</h3>
                        <p class="mt-2 text-md text-slate-500">Keputusan CapEx dimulai dengan memahami kinerja saat ini dan mendefinisikan proyek masa depan.</p>
                    </div>
                    <div class="grid md:grid-cols-2 gap-8 items-start">
                        <div class="section-card p-6">
                            <h4 class="text-xl font-semibold mb-3">Kinerja Aset Operasional</h4>
                            <p class="text-slate-600 mb-4">Menganalisis pendapatan dan pengeluaran historis aset yang ada memberikan dasar untuk proyeksi masa depan dan membantu mengidentifikasi kebutuhan untuk penggantian atau peningkatan. Bagan ini menunjukkan tren sampel untuk satu aset, diperbarui dari data yang Anda unggah.</p>
                            <div class="chart-container">
                                <canvas id="operatingAssetChart"></canvas>
                            </div>
                        </div>
                        <div class="section-card p-6">
                            <h4 class="text-xl font-semibold mb-3">Mendefinisikan Proyek CapEx</h4>
                            <p class="text-slate-600 mb-4">Setiap proyek harus didefinisikan dengan jelas dengan biaya, tujuan, dan jenis aset yang sedang dibuat. Konteks ini sangat penting untuk penyelarasan strategis dan pemodelan keuangan. (Bagian ini menggunakan data tiruan statis untuk definisi proyek; proyeksi keuangan berasal dari CSV Anda.)</p>
                            <div class="bg-slate-50 p-4 rounded-lg space-y-3">
                                <div><strong class="text-slate-700">ID Proyek:</strong> <span class="font-mono text-sm bg-slate-200 px-2 py-1 rounded">P_001_Gudang_Baru</span></div>
                                <div><strong class="text-slate-700">Nama Proyek:</strong> <span>Pusat Distribusi Pantai Barat</span></div>
                                <div><strong class="text-slate-700">CapEx Proyeksi:</strong> <span>$5.000.000</span></div>
                                <div><strong class="text-slate-700">Jenis Aset:</strong> <span>Bangunan</span></div>
                                <div><strong class="text-slate-700">Tujuan:</strong> <span class="bg-blue-100 text-blue-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">Pertumbuhan/Ekspansi</span></div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="evaluation" class="mb-20 space-y-12">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-slate-800">Mesin Evaluasi</h3>
                        <p class="mt-2 text-md text-slate-500">Di sini kami memproyeksikan arus kas masa depan dan menggunakan metrik keuangan utama untuk menentukan kelayakan proyek.</p>
                    </div>
                    <div class="section-card p-6 mb-8">
                        <h4 class="text-xl font-semibold mb-3">Kinerja Keuangan Proyeksi</h4>
                        <p class="text-slate-600 mb-4">Setelah proyek didefinisikan, kami memproyeksikan pendapatan dan biayanya di masa depan. Arus kas bersih yang dihasilkan adalah dasar untuk semua metrik valuasi. Bagan ini menunjukkan proyeksi 10 tahun untuk proyek gudang baru kami, diperbarui dari data yang Anda unggah.</p>
                        <div class="chart-container">
                            <canvas id="projectionChart"></canvas>
                        </div>
                    </div>
                    <div class="section-card p-6">
                        <h4 class="text-xl font-semibold mb-3">Kalkulator Metrik Interaktif (NPV & IRR)</h4>
                        <p class="text-slate-600 mb-4">Nilai Sekarang Bersih (NPV) dan Tingkat Pengembalian Internal (IRR) sangat penting untuk menilai profitabilitas. NPV memberi tahu kita nilai yang ditambahkan proyek dalam dolar saat ini, sementara IRR adalah tingkat pengembalian yang diharapkan proyek. Sesuaikan arus kas atau tingkat diskonto di bawah ini untuk melihat bagaimana pengaruhnya terhadap hasil. Arus kas dimuat dari CSV Anda.</p>
                        <div class="grid md:grid-cols-3 gap-6">
                            <div class="md:col-span-2 space-y-4">
                                <div class="flex items-center space-x-2">
                                    <label for="discountRate" class="font-medium text-slate-700 w-32">Tingkat Diskon:</label>
                                    <input type="number" id="discountRate" value="10" class="w-24 p-2 border rounded-md">
                                    <span>%</span>
                                </div>
                                <div class="space-y-2" id="cashflow-inputs">
                                    <p class="text-slate-500">Unggah CSV Arus Kas untuk mengisi input.</p>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-lg flex flex-col justify-center items-center text-center">
                                <div class="mb-4">
                                    <h5 class="text-lg font-semibold text-slate-800">Nilai Sekarang Bersih (NPV)</h5>
                                    <p id="npv-result" class="text-3xl font-bold text-blue-600">$0</p>
                                </div>
                                <div>
                                    <h5 class="text-lg font-semibold text-slate-800">Tingkat Pengembalian Internal (IRR)</h5>
                                    <p id="irr-result" class="text-3xl font-bold text-green-600">0%</p>
                                </div>
                                <p id="decision-rule" class="mt-4 text-sm font-medium text-slate-600"></p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="risk" class="mb-20">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-slate-800">Penilaian Risiko</h3>
                        <p class="mt-2 text-md text-slate-500">Mengukur risiko adalah kunci untuk membuat keputusan investasi yang kuat.</p>
                    </div>
                    <div class="section-card p-6 mt-8">
                        <h4 class="text-xl font-semibold mb-3">Matriks Risiko Proyek Interaktif</h4>
                        <p class="text-slate-600 mb-4">Matriks risiko membantu memvisualisasikan dan memprioritaskan risiko proyek berdasarkan kemungkinan dan dampak potensinya. Gunakan slider untuk memilih skor kemungkinan dan dampak, dan lihat bagaimana peringkat risiko berubah. Risiko berperingkat tinggi memerlukan perhatian segera dan perencanaan mitigasi.</p>
                        <div class="grid md:grid-cols-2 gap-8 items-center">
                            <div>
                                <div class="space-y-4">
                                    <div>
                                        <label for="likelihood-slider" class="block mb-2 font-medium text-slate-700">Kemungkinan: <span id="likelihood-value" class="font-bold">3</span></label>
                                        <input type="range" min="1" max="5" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" id="likelihood-slider-proposer">
                                    </div>
                                    <div>
                                        <label for="impact-slider" class="block mb-2 font-medium text-slate-700">Dampak: <span id="impact-value" class="font-bold">3</span></label>
                                        <input type="range" min="1" max="5" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" id="impact-slider-proposer">
                                    </div>
                                </div>
                                <div class="mt-6 bg-slate-50 p-4 rounded-lg text-center">
                                    <h5 class="text-lg font-semibold text-slate-800">Peringkat Risiko</h5>
                                    <p class="text-3xl font-bold" id="risk-rating-proposer">9</p>
                                    <p class="text-xl font-semibold" id="risk-category-proposer">Sedang</p>
                                </div>
                            </div>
                            <div class="flex justify-center items-center">
                                <div id="risk-matrix-proposer" class="risk-matrix-grid"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="memo-generation" class="mb-20">
                    <div class="text-center mb-10">
                        <h3 class="text-2xl font-bold text-slate-800">Buat Ringkasan Memo Investasi</h3>
                        <p class="mt-2 text-md text-slate-500">Gunakan AI untuk secara otomatis membuat memo investasi ringkas berdasarkan data dan analisis yang Anda unggah. Memo ini kemudian dapat dikirim untuk ditinjau oleh komite.</p>
                    </div>
                    <div class="section-card p-6">
                        <!-- New Manual Input Fields for Memo Criteria -->
                        <div class="mb-6 space-y-4">
                            <div>
                                <label for="memoPurposeInput" class="block text-sm font-medium text-slate-700 mb-2">2. Kepentingan / Objektivitas / Tujuan</label>
                                <textarea id="memoPurposeInput" class="w-full p-2 border rounded-md resize-y" rows="3" placeholder="Diisi Penjelasan singkat sesuai dengan penjelasan pada kajian aspek Kepentingan/Objektivitas/Tujuan menunjukkan bahwa …."></textarea>
                            </div>
                            <div>
                                <label for="memoEnvironmentalInput" class="block text-sm font-medium text-slate-700 mb-2">3. Lingkungan, Sosial, dan Ekonomi</label>
                                <textarea id="memoEnvironmentalInput" class="w-full p-2 border rounded-md resize-y" rows="3" placeholder="Diisi Penjelasan singkat sesuai dengan penjelasan pada kajian aspek Sosial dan Ekonomi menunjukkan bahwa e.g.: Jumlah tenaga kerja yang dilibatkan, Kontribusi terhadap GDP, Dampak Lingkungan"></textarea>
                            </div>
                            <div>
                                <label for="memoFiscalInput" class="block text-sm font-medium text-slate-700 mb-2">4. Fiskal</label>
                                <textarea id="memoFiscalInput" class="w-full p-2 border rounded-md resize-y" rows="3" placeholder="Diisi Penjelasan singkat sesuai dengan penjelasan pada kajian aspek Fiskal menunjukkan bahwa e.g.: Kontribusi Pajak Pemerintah Pusat/Daerah, Nilai kontribusi perusahaan sebagai agent of development ( kontribusi pajak dan PNBP sebesar Rp xxx,- , kontribusi Dividen sebesar Rp xxx,- dll), Besaran Insentif Pajak"></textarea>
                            </div>
                            <div>
                                <label for="memoOperationalInput" class="block text-sm font-medium text-slate-700 mb-2">5. Pelayanan dan Operasional</label>
                                <textarea id="memoOperationalInput" class="w-full p-2 border rounded-md resize-y" rows="3" placeholder="Diisi sesuai dengan penjelasan pada kajian / lampiran e.g.: Menjaga skor CSI dengan target sebesar …, Downtime Operation (Serviceability Percentage), Length of Stay, Meminimalisasi Complain Resolution Rate, Peningkatan Jumlah Pengguna Jasa (Penumpang/Wisatawan/Visitor), Peningkatan Occupancy Rate, Pemenuhan 3S (Safety, Security, dan Services), Pemenuhan K3 (Kesehatan dan Keselamatan Kerja)"></textarea>
                            </div>
                            <div>
                                <label for="memoLegalInput" class="block text-sm font-medium text-slate-700 mb-2">6. Legal</label>
                                <textarea id="memoLegalInput" class="w-full p-2 border rounded-md resize-y" rows="3" placeholder="Diisi sesuai dengan penjelasan pada kajian / lampiran e.g.: Analisa Hukum terkait Ketentuan Undang Undang Perseroan Terbatas, BUMN dan Ketentuan Internal Governance di Perusahaan, Analisa Hukum terkait Hubungan Hukum dengan Pihak Ketiga (jika ada), Analisa Pelaksanaan Fiduciary Duty Direksi Perusahaan, Analisa Hukum terkait Lainnya (jika ada), Analisa Risiko Hukum dan Mitigasi"></textarea>
                            </div>
                            <div>
                                <label for="memoRiskManagementInput" class="block text-sm font-medium text-slate-700 mb-2">7. Manajemen Risiko</label>
                                <textarea id="memoRiskManagementInput" class="w-full p-2 border rounded-md resize-y" rows="3" placeholder="Diisi sesuai dengan penjelasan pada kajian / lampiran e.g.: Nilai Eksposur Risiko, Biaya MItigasi Risiko"></textarea>
                            </div>
                            <div>
                                <label for="memoGovernanceInput" class="block text-sm font-medium text-slate-700 mb-2">8. Corporate Governance & Compliance</label>
                                <textarea id="memoGovernanceInput" class="w-full p-2 border rounded-md resize-y" rows="3" placeholder="Diisi sesuai dengan penjelasan pada kajian / lampiran e.g.: Penjelasan singkat terkait tingkat kepatuhan terhadap dokumen kelengkapan investasi/aksi korporasi dari Pengusul, Penjelasan singkat terkait tingkat kepatuhan internal"></textarea>
                            </div>
                            <div>
                                <label for="memoOtherAspectsInput" class="block text-sm font-medium text-slate-700 mb-2">9. Aspek Lainnya</label>
                                <textarea id="memoOtherAspectsInput" class="w-full p-2 border rounded-md resize-y" rows="3" placeholder="Dapat diusulkan parameter terkait aspek lainnya oleh Unit Terkait lainnya, e.g.: Meng-counter Sentimen Pemberitaan, Pemenuhan SLA untuk IT Maturity, SDM"></textarea>
                            </div>
                        </div>

                        <button id="generateMemoBtn" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Buat Memo Investasi</button>
                        <div id="memoGenerationStatus" class="mt-4 text-sm text-slate-600"></div>
                        <div id="generatedMemoDisplay" class="mt-6 p-4 bg-slate-50 rounded-lg hidden">
                            <h4 class="text-xl font-semibold mb-3">Memo yang Dihasilkan:</h4>
                            <p id="memoContent" class="text-slate-700 whitespace-pre-wrap"></p>
                            <button id="sendForReviewBtn" class="mt-4 px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Kirim untuk Peninjauan Komite</button>
                        </div>
                    </div>
                </section>

                <section id="memos-section-for-proposer-message" class="mb-20 hidden">
                    <div class="text-center mb-10 section-card p-6">
                        <h3 class="text-2xl font-bold text-slate-800">Memo Investasi untuk Ditinjau</h3>
                        <p class="mt-2 text-md text-slate-500">Sebagai pengusul investasi, Anda tidak dapat langsung meninjau memo di sini. Memo yang Anda kirim sedang menunggu peninjauan oleh komite investasi perusahaan induk.</p>
                    </div>
                </section>
            </div>

            <!-- Committee View -->
            <div id="committee-view" class="hidden">
                <section id="committee-dashboard" class="mb-20 section-card p-8">
                    <h3 class="text-2xl font-bold text-slate-800 mb-4">Dasbor Komite Investasi</h3>
                    <p class="text-md text-slate-600 mb-6">Selamat datang, Anggota Komite Investasi! Berikut adalah ikhtisar memo yang membutuhkan perhatian Anda.</p>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-blue-50 p-6 rounded-lg text-center">
                            <h4 class="text-lg font-semibold text-blue-800">Memo Menunggu Peninjauan</h4>
                            <p id="pendingMemosCount" class="text-5xl font-bold text-blue-600 mt-2">0</p>
                            <p id="pendingMemosMessage" class="text-sm text-blue-700 mt-2">Anda memiliki <span id="pendingMemosCountMessage">0</span> memo yang harus ditinjau.</p>
                        </div>
                        <div class="bg-purple-50 p-6 rounded-lg text-center flex flex-col justify-center">
                            <h4 class="text-lg font-semibold text-purple-800 mb-3">Tindakan Diperlukan</h4>
                            <a href="#memos" class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition-colors">Pergi ke Memo untuk Ditinjau</a>
                        </div>
                    </div>
                </section>

                <section id="memos" class="mb-20">
                    <div class="text-center mb-10">
                        <h3 class="2xl font-bold text-slate-800">Memo Investasi untuk Ditinjau</h3>
                        <p class="mt-2 text-md text-slate-500">Lihat dan komentari memo investasi. Peninjau dari perusahaan induk harus memberikan umpan balik dalam waktu tiga hari.</p>
                    </div>
                    <div class="section-card p-6">
                        <div id="memoList" class="space-y-4">
                            <p class="text-slate-500">Tidak ada memo yang tersedia untuk ditinjau.</p>
                        </div>

                        <div id="memoDetailView" class="hidden mt-8 p-6 bg-slate-50 rounded-lg">
                            <h4 id="memoDetailTitle" class="text-xl font-bold text-slate-800 mb-3"></h4>
                            <p id="memoDetailContent" class="text-slate-700 whitespace-pre-wrap mb-4"></p>
                            <p class="text-sm text-slate-600 mb-2">Status: <span id="memoDetailStatus" class="font-semibold"></span> | Dikirim oleh: <span id="memoDetailAuthor" class="font-semibold"></span> | Batas Waktu: <span id="memoDetailDeadline" class="font-semibold"></span></p>
                            <button id="markAsReviewedBtn" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-md hover:bg-purple-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed mt-2">Tandai sebagai Ditinjau</button>
                            <button id="backToMemoListBtn" class="px-4 py-2 bg-gray-300 text-slate-800 font-semibold rounded-md hover:bg-gray-400 transition-colors mt-2 ml-2">Kembali ke Daftar</button>

                            <h5 class="text-lg font-semibold text-slate-800 mt-6 mb-3">Komentar:</h5>
                            <div id="commentsList" class="space-y-3 mb-4">
                                <p class="text-slate-500">Belum ada komentar.</p>
                            </div>

                            <div class="mt-4">
                                <textarea id="commentInput" class="w-full p-2 border rounded-md resize-y" rows="3" placeholder="Tambahkan komentar Anda di sini..."></textarea>
                                <button id="addCommentBtn" class="mt-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Tambahkan Komentar</button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Schema section common for both roles, but only visible if navigated to -->
            <section id="schema" class="mb-20">
                <div class="text-center">
                    <h3 class="text-2xl font-bold text-slate-800">Penjelajah Skema Data</h3>
                    <p class="mt-2 text-md text-slate-500">Analisis yang sukses bergantung pada data yang terstruktur dengan baik. Jelajahi struktur data CSV yang diperlukan di bawah ini.</p>
                </div>
                <div class="w-full max-w-4xl mx-auto mt-8">
                    <div class="mb-4 flex flex-wrap justify-center border-b border-gray-200">
                        <button class="tab-button flex-grow md:flex-grow-0 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent px-4 py-2 hover:text-gray-600 hover:border-gray-300" data-target="table1">Aset Operasional</button>
                        <button class="tab-button flex-grow md:flex-grow-0 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent px-4 py-2 hover:text-gray-600 hover:border-gray-300" data-target="table2">Proyek CapEx</button>
                        <button class="tab-button flex-grow md:flex-grow-0 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent px-4 py-2 hover:text-gray-600 hover:border-gray-300" data-target="table3">Input Metrik</button>
                        <button class="tab-button flex-grow md:flex-grow-0 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent px-4 py-2 hover:text-gray-600 hover:border-gray-300" data-target="table4">Matriks Risiko</button>
                        <button class="tab-button flex-grow md:flex-grow-0 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent px-4 py-2 hover:text-gray-600 hover:border-gray-300" data-target="table5">Proyeksi Aset Baru</button>
                    </div>
                    <div id="tab-content" class="bg-white p-6 rounded-lg shadow-md">
                    </div>
                </div>
            </section>
        </div>

    </main>

    <footer class="bg-slate-800 text-slate-300 mt-16">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center text-sm">
            <p>Kerangka Kerja Analisis CapEx Interaktif | Dibangun untuk mendemonstrasikan konsep dari laporan sumber.</p>
            <p class="mt-1">Catatan: Notifikasi dan pengiriman komentar otomatis disimulasikan fitur sisi klien untuk tujuan demonstrasi.</p>
        </div>
    </footer>

    <script type="module">
        // Ensure Firebase variables are available from the head script
        const app = window.firebaseApp;
        const db = window.firebaseDb;
        const appId = window.firebaseAppId;
        const serverTimestamp = window.firebaseServerTimestamp;
        // Firestore functions
        const collection = window.firebaseCollection;
        const doc = window.firebaseDoc;
        const getDoc = window.firebaseGetDoc;
        const addDoc = window.firebaseAddDoc;
        const setDoc = window.firebaseSetDoc;
        const updateDoc = window.firebaseUpdateDoc;
        const deleteDoc = window.firebaseDeleteDoc;
        const onSnapshot = window.firebaseOnSnapshot;
        const query = window.firebaseQuery;
        const where = window.firebaseWhere;
        
        // userRole and currentUserId are now managed by the slider
        
        let operatingAssetData = null;
        let projectionData = null;
        let cashflowData = null;
        let currentNPV = 0;
        let currentIRR = 0;
        let currentRiskRating = 0;
        let currentRiskCategory = '';

        const uploadStatusEl = document.getElementById('uploadStatus');
        const generateMemoBtn = document.getElementById('generateMemoBtn');
        const memoGenerationStatusEl = document.getElementById('memoGenerationStatus');
        const generatedMemoDisplayEl = document.getElementById('generatedMemoDisplay');
        const memoContentEl = document.getElementById('memoContent');
        const sendForReviewBtn = document.getElementById('sendForReviewBtn');
        const memoListEl = document.getElementById('memoList');
        const memoDetailViewEl = document.getElementById('memoDetailView');
        const memoDetailTitleEl = document.getElementById('memoDetailTitle');
        const memoDetailContentEl = document.getElementById('memoDetailContent');
        const memoDetailStatusEl = document.getElementById('memoDetailStatus');
        const memoDetailAuthorEl = document.getElementById('memoDetailAuthor');
        const memoDetailDeadlineEl = document.getElementById('memoDetailDeadline');
        const markAsReviewedBtn = document.getElementById('markAsReviewedBtn');
        const backToMemoListBtn = document.getElementById('backToMemoListBtn');
        const commentsListEl = document.getElementById('commentsList');
        const commentInputEl = document.getElementById('commentInput');
        const addCommentBtn = document.getElementById('addCommentBtn');
        const roleSlider = document.getElementById('role-slider');
        const authStatusEl = document.getElementById('auth-status');

        // New elements for manual memo input
        const memoPurposeInput = document.getElementById('memoPurposeInput');
        const memoEnvironmentalInput = document.getElementById('memoEnvironmentalInput');
        const memoFiscalInput = document.getElementById('memoFiscalInput');
        const memoOperationalInput = document.getElementById('memoOperationalInput');
        const memoLegalInput = document.getElementById('memoLegalInput');
        const memoRiskManagementInput = document.getElementById('memoRiskManagementInput');
        const memoGovernanceInput = document.getElementById('memoGovernanceInput');
        const memoOtherAspectsInput = document.getElementById('memoOtherAspectsInput');


        let currentMemoId = null; // To track the memo currently being viewed/commented on

        const schemas = {
            table1: {
                title: 'Tabel 1: Keuangan Aset Operasional',
                description: 'Menangkap kinerja operasional historis atau saat ini dari aset yang ada. Ini menyediakan data dasar kontekstual untuk kesehatan bisnis secara keseluruhan dan menginformasikan asumsi untuk proyeksi aset baru.',
                columns: [
                    { name: 'Tahun', type: 'Integer', desc: 'Tahun untuk data keuangan.' },
                    { name: 'Pendapatan_Operasional', type: 'Numeric, USD', desc: 'Pendapatan yang dihasilkan langsung dari aktivitas bisnis utama aset ini.' },
                    { name: 'Beban_Operasional', type: 'Numeric, USD', desc: 'Biaya sehari-hari yang dikeluarkan untuk menjalankan aset spesifik ini.' }
                ]
            },
            table2: {
                title: 'Tabel 2: Data Proyek Belanja Modal',
                description: 'Mendefinisikan, mengkuantifikasi, dan mengkategorikan proyek belanja modal yang diusulkan, menyediakan data investasi awal yang penting untuk evaluasi proyek.',
                columns: [
                    { name: 'ID_Proyek', type: 'String', desc: 'Pengidentifikasi unik untuk setiap proyek CapEx yang berbeda.' },
                    { name: 'Nama_Proyek', type: 'String', desc: 'Nama deskriptif untuk proyek belanja modal.' },
                    { name: 'Jumlah_CapEx_Proyeksi', type: 'Numeric, USD', desc: 'Total perkiraan belanja modal untuk proyek spesifik ini. Untuk proyek multi-tahun, ini bisa mewakili total biaya proyek, atau angsuran tahunan jika bertahap.' },
                    { name: 'Tahun_Pengeluaran', type: 'Integer', desc: 'Tahun kalender di mana belanja modal utama (atau sebagian besar darinya) diharapkan terjadi (misalnya, 2025). Ini penting untuk waktu arus kas dalam model keuangan.' },
                    { name: 'Jenis_Aset', type: 'String', desc: 'Jenis utama aset yang diakuisisi atau ditingkatkan secara signifikan.' },
                    { name: 'Tujuan_CapEx', type: 'String', desc: 'Alasan strategis utama di balik pengeluaran (misalnya, \'Pertumbuhan/Ekspansi\', \'Pemeliharaan/Penggantian\', \'Peningkatan Efisiensi\', \'Kepatuhan/Regulasi\', \'Pengembangan Produk Baru\').' }
                ]
            },
            table3: {
                title: 'Tabel 3: Data Input Metrik Keuangan',
                description: 'Menyediakan data arus kas deret waktu yang diperlukan dan tingkat diskonto yang diperlukan untuk perhitungan metrik keuangan CapEx utama seperti Net Present Value (NPV), Internal Rate of Return (IRR), Periode Pengembalian, dan Return on Investment (ROI).',
                columns: [
                    { name: 'ID_Proyek', type: 'String', desc: 'Tautan ke proyek CapEx yang didefinisikan dalam Tabel 2.' },
                    { name: 'Tahun', type: 'Integer', desc: 'Tahun arus kas relatif terhadap awal proyek (Tahun 0 adalah investasi awal).' },
                    { name: 'Arus_Kas', type: 'Numeric, USD', desc: 'Arus kas bersih (arus masuk dikurangi arus keluar) yang dihasilkan oleh (atau diperlukan untuk) proyek pada tahun tertentu. Tahun 0 biasanya akan menjadi nilai negatif yang mewakili investasi awal. Tahun-tahun berikutnya bisa positif (arus masuk dari operasi) atau negatif (arus keluar tambahan).' },
                    { name: 'Investasi_Awal', type: 'Numeric, USD', desc: 'Total pengeluaran modal awal untuk proyek, biasanya terjadi pada Tahun 0. Meskipun dapat diturunkan dari `Arus_Kas` pada Tahun 0, penyertaan eksplisitnya membantu kejelasan dan merupakan input langsung untuk perhitungan ROI dan Periode Pengembalian.' },
                    { name: 'Tingkat_Diskon_Proyek', type: 'Numeric, % as decimal', desc: 'Tingkat diskonto spesifik yang digunakan untuk proyek ini, mencerminkan profil risiko uniknya dan biaya modal perusahaan (misalnya, 0,10 untuk 10%).' }
                ]
            },
            table4: {
                title: 'Tabel 4: Data Matriks Risiko Proyek',
                description: 'Mengkuantifikasi dan mengkategorikan risiko-risiko utama yang terkait dengan setiap proyek belanja modal, memungkinkan penilaian dan prioritas risiko yang terstruktur.',
                columns: [
                    { name: 'ID_Proyek', type: 'String', desc: 'Tautan ke proyek CapEx.' },
                    { name: 'ID_Risiko', type: 'String', desc: 'Pengidentifikasi unik untuk setiap risiko spesifik yang teridentifikasi (misalnya, \'R_001_Usang_Teknologi\', \'R_002_Gangguan_Rantai_Pasokan\').' },
                    { name: 'Deskripsi_Risiko', type: 'String', desc: 'Deskripsi ringkas tentang potensi risiko (misalnya, \'Adopsi teknologi baru lebih rendah dari yang diharapkan\', \'Volatilitas harga bahan baku utama\').' },
                    { name: 'Skor_Kemungkinan', type: 'Integer', desc: 'Skor yang mewakili kemungkinan terjadinya risiko, berdasarkan skala yang ditentukan (misalnya, 1-5, di mana 1=Sangat Tidak Mungkin, 2=Tidak Mungkin, 3=Mungkin, 4=Probable, 5=Sangat Mungkin).' },
                    { name: 'Skor_Dampak', type: 'Integer', desc: 'Skor yang mewakili tingkat keparahan konsekuensi jika risiko terjadi, berdasarkan skala yang ditentukan (misalnya, 1-5, di mana 1=Sepele, 2=Rendah, 3=Sedang, 4=Tinggi, 5=Bencana).' },
                    { name: 'Peringkat_Risiko', type: 'Integer', desc: 'Peringkat risiko yang dihitung, berasal dari perkalian `Skor_Kemungkinan` dengan `Skor_Dampak`.' },
                    { name: 'Kategori_Risiko', type: 'String', desc: 'Klasifikasi kualitatif dari `Peringkat_Risiko` (misalnya, \'Rendah\' (1-6), \'Sedang\' (7-12), \'Tinggi\' (13-25)).' }
                ]
            },
            table5: {
                title: 'Tabel 5: Proyeksi Keuangan Aset Baru',
                description: 'Menyediakan proyeksi keuangan tahunan yang terperinci untuk pendapatan dan biaya yang secara khusus terkait dengan aset yang dibuat atau ditingkatkan secara signifikan oleh proyek CapEx, membentuk dasar untuk arus kas proyek yang berkelanjutan.',
                columns: [
                    { name: 'ID_Proyek', type: 'String', desc: 'Links to the CapEx project.' },
                    { name: 'Tahun', type: 'Integer', desc: 'The projection year, relative to the asset becoming operational (e.g., 1, 2, 3... over its projected useful life).' },
                    { name: 'Pendapatan_Proyeksi', type: 'Numeric, USD', desc: 'The gross revenue directly attributable to the new asset\'s operation in that year.' },
                    { name: 'Biaya_Operasional_Proyeksi', type: 'Numeric, USD', desc: 'All operating expenses directly associated with running the new asset in that year (e.g., O&M, direct labor, asset-specific utilities, marketing costs for asset\'s output).' },
                    { name: 'Beban_Penyusutan', type: 'Numeric, USD', desc: 'The annual depreciation expense recognized for the capitalized asset in that year.' },
                    { name: 'Beban_Pajak', type: 'Numeric, USD', desc: 'The estimated annual tax expense related to the asset\'s profitability, calculated based on projected taxable income.' },
                    { name: 'CapEx_Pemeliharaan_Modal', type: 'Numeric, USD', desc: 'Any recurring or periodic capital expenditures specifically needed to maintain the asset\'s functionality, extend its life, or ensure its continued operation at projected levels. These are distinct from initial project CapEx.' },
                    { name: 'Arus_Kas_Bersih_dari_Aset', type: 'Numeric, USD', desc: 'The calculated net cash flow derived directly from the asset\'s operations in that year. This is typically calculated as `Projected_Revenue - Projected_Operating_Costs - Tax_Expense - Capital_Maintenance_CapEx + Depreciation_Expense` (Depreciation is added back as it\'s a non-cash expense). This value serves as a key input for the `Cash_Flow` in Table 3.' }
                ]
            }
        };
        
        Chart.defaults.font.family = "'Inter', sans-serif";

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
        }

        let operatingAssetChartInstance = null;
        function createOperatingAssetChart(data) {
            if (operatingAssetChartInstance) {
                operatingAssetChartInstance.destroy();
            }
            const ctx = document.getElementById('operatingAssetChart').getContext('2d');
            operatingAssetChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Pendapatan Operasional',
                        data: data.revenue,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.3
                    }, {
                        label: 'Beban Operasional',
                        data: data.expenses,
                        borderColor: '#db2777',
                        backgroundColor: 'rgba(219, 39, 119, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) { return '$' + value / 1000 + 'K'; }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        let projectionChartInstance = null;
        function createProjectionChart(data) {
            if (projectionChartInstance) {
                projectionChartInstance.destroy();
            }
            const ctx = document.getElementById('projectionChart').getContext('2d');
            const netCashFlow = data.revenue.map((rev, i) => rev - data.costs[i]);
            projectionChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Pendapatan Proyeksi',
                        data: data.revenue,
                        backgroundColor: '#34d399',
                    }, {
                        label: 'Biaya Proyeksi',
                        data: data.costs,
                        backgroundColor: '#f87171',
                    }, {
                        label: 'Arus Kas Bersih',
                        data: netCashFlow,
                        backgroundColor: '#60a5fa',
                        type: 'line',
                        borderColor: '#2563eb',
                        tension: 0.3,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { 
                            stacked: true,
                            ticks: {
                                callback: function(value) { return '$' + value / 1000 + 'K'; }
                            }
                        }
                    },
                     plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function initCalculator(cashflows) {
            const cashflowInputsContainer = document.getElementById('cashflow-inputs');
            const discountRateInput = document.getElementById('discountRate');
            
            function setupInputs(cfs) {
                cashflowInputsContainer.innerHTML = '';
                if (!cfs || cfs.length === 0) {
                    cashflowInputsContainer.innerHTML = '<p class="text-slate-500">Unggah CSV Arus Kas untuk mengisi input.</p>';
                    return;
                }
                cfs.forEach((cf, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-2';
                    const label = document.createElement('label');
                    label.className = 'font-medium text-slate-700 w-32';
                    label.textContent = `Arus Kas Tahun ${index}:`;
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'cashflow-input w-48 p-2 border rounded-md';
                    input.value = cf;
                    div.appendChild(label);
                    div.appendChild(input);
                    cashflowInputsContainer.appendChild(div);
                });
            }

            function calculate() {
                const cfs = Array.from(document.getElementsByClassName('cashflow-input')).map(input => parseFloat(input.value) || 0);
                const rate = parseFloat(discountRateInput.value) / 100 || 0;

                let npv = 0;
                for (let i = 0; i < cfs.length; i++) {
                    npv += cfs[i] / Math.pow(1 + rate, i);
                }

                let irr = calculateIRR(cfs);

                currentNPV = npv;
                currentIRR = irr;

                document.getElementById('npv-result').textContent = formatCurrency(npv);
                document.getElementById('irr-result').textContent = (irr * 100).toFixed(2) + '%';
                
                const decisionRuleEl = document.getElementById('decision-rule');
                if (npv > 0) {
                    decisionRuleEl.textContent = 'NPV positif menunjukkan proyek layak secara finansial.';
                    decisionRuleEl.className = 'mt-4 text-sm font-medium text-green-700';
                } else {
                    decisionRuleEl.textContent = 'NPV negatif menunjukkan proyek mungkin tidak layak.';
                    decisionRuleEl.className = 'mt-4 text-sm font-medium text-red-700';
                }
            }

            function calculateIRR(cfs, guess = 0.1) {
                const maxIterations = 100;
                const precision = 1e-7;
                let x0 = guess;

                for (let i = 0; i < maxIterations; i++) {
                    let npv = 0;
                    let derivative = 0;
                    for (let t = 0; t < cfs.length; t++) {
                        npv += cfs[t] / Math.pow(1 + x0, t);
                        derivative -= t * cfs[t] / Math.pow(1 + x0, t + 1);
                    }
                    if (Math.abs(npv) < precision) return x0;
                    if (derivative === 0) break;
                    x0 = x0 - npv / derivative;
                }
                return NaN; 
            }
            
            setupInputs(cashflows);
            calculate();
            cashflowInputsContainer.addEventListener('input', calculate);
            discountRateInput.addEventListener('input', calculate);
        }

        function initRiskMatrix() {
            const matrixContainer = document.getElementById('risk-matrix-proposer');
            const likelihoodSlider = document.getElementById('likelihood-slider-proposer');
            const impactSlider = document.getElementById('impact-slider-proposer');
            const likelihoodValue = document.getElementById('likelihood-value');
            const impactValue = document.getElementById('impact-value');
            const riskRatingEl = document.getElementById('risk-rating-proposer');
            const riskCategoryEl = document.getElementById('risk-category-proposer');

            const likelihoodLabels = ['Jarang', 'Tidak Mungkin', 'Mungkin', 'Kemungkinan', 'Pasti'];
            const impactLabels = ['Sepele', 'Minor', 'Sedang', 'Besar', 'Parah'];

            function createMatrix() {
                matrixContainer.innerHTML = '';
                // Add empty cell for alignment in the first row, first column
                const emptyHeaderCell = document.createElement('div');
                emptyHeaderCell.className = 'text-xs font-bold text-slate-500 text-center flex items-center justify-center';
                matrixContainer.appendChild(emptyHeaderCell);

                // Impact labels (top row)
                impactLabels.forEach(h => {
                    const cell = document.createElement('div');
                    cell.className = 'text-xs font-bold text-slate-500 text-center flex items-center justify-center p-1';
                    cell.textContent = h;
                    matrixContainer.appendChild(cell);
                });

                // Matrix cells and likelihood labels (rows)
                for (let i = 5; i >= 1; i--) { // Likelihood from 5 (high) to 1 (low)
                    const rowLabel = document.createElement('div');
                    rowLabel.className = 'text-xs font-bold text-slate-500 text-center flex items-center justify-center p-1';
                    rowLabel.textContent = likelihoodLabels[i-1]; // Adjust index for label
                    matrixContainer.appendChild(rowLabel);
                    for (let j = 1; j <= 5; j++) { // Impact from 1 (low) to 5 (high)
                        const cell = document.createElement('div');
                        cell.id = `risk-cell-${i}-${j}`;
                        cell.className = 'risk-cell';
                        cell.textContent = i * j;
                        matrixContainer.appendChild(cell);
                    }
                }
            }

            function updateMatrix() {
                const likelihood = parseInt(likelihoodSlider.value);
                const impact = parseInt(impactSlider.value);
                const rating = likelihood * impact;

                currentRiskRating = rating;
                let category;
                if (rating >= 15) { category = 'Tinggi'; } 
                else if (rating >= 7) { category = 'Sedang'; } 
                else { category = 'Rendah'; }
                currentRiskCategory = category;


                likelihoodValue.textContent = `${likelihood} (${likelihoodLabels[likelihood-1]})`;
                impactValue.textContent = `${impact} (${impactLabels[impact-1]})`;
                riskRatingEl.textContent = rating;

                let color;
                if (rating >= 15) { color = 'bg-red-500'; } 
                else if (rating >= 7) { color = 'bg-yellow-400'; } 
                else { color = 'bg-green-400'; }
                
                riskCategoryEl.textContent = category;
                riskCategoryEl.className = `text-xl font-semibold text-white px-4 py-1 rounded-full ${color}`;
                riskRatingEl.style.color = color.replace('bg-', '').replace('-500', '-600').replace('-400', '-500');


                document.querySelectorAll('.risk-cell').forEach(c => {
                    c.classList.remove('highlight');
                    const r = parseInt(c.textContent);
                    if (r >= 15) c.style.backgroundColor = '#fecaca'; // red-200
                    else if (r >= 7) c.style.backgroundColor = '#fef08a'; // yellow-200
                    else c.style.backgroundColor = '#bbf7d0'; // green-200
                });

                const activeCell = document.getElementById(`risk-cell-${likelihood}-${impact}`);
                if (activeCell) {
                    activeCell.classList.add('highlight');
                    activeCell.style.backgroundColor = color;
                }
            }

            createMatrix();
            updateMatrix();
            likelihoodSlider.addEventListener('input', updateMatrix);
            impactSlider.addEventListener('input', updateMatrix);
        }

        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContent = document.getElementById('tab-content');

            function displayTabContent(targetId) {
                const schema = schemas[targetId];
                if (!schema) return;

                let contentHTML = `<h4 class="text-xl font-semibold mb-2">${schema.title}</h4>`;
                contentHTML += `<p class="text-slate-600 mb-6">${schema.description}</p>`;
                contentHTML += `<div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500">`;
                contentHTML += `<thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr>
                    <th scope="col" class="px-6 py-3">Nama Kolom</th>
                    <th scope="col" class="px-6 py-3">Tipe Data</th>
                    <th scope="col" class="px-6 py-3">Deskripsi</th>
                    </tr></thead><tbody>`;
                
                schema.columns.forEach(col => {
                    contentHTML += `<tr class="bg-white border-b">
                        <th scope="row" class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">${col.name}</th>
                        <td class="px-6 py-4 font-mono text-xs">${col.type}</td>
                        <td class="px-6 py-4">${col.desc}</td>
                    </tr>`;
                });

                contentHTML += `</tbody></table></div>`;
                tabContent.innerHTML = contentHTML;
            }

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    displayTabContent(button.dataset.target);
                });
            });
            
            // Set default active tab
            tabButtons[0].click();
        }

        // Helper functions to process CSV data (PLACEHOLDERS - replace with actual parsing logic)
        function processOperatingAssetCSV(data) {
            // Assuming data is an array of objects like [{Year: "2020", Operating_Revenue: "100000", Operating_Expenses: "50000"}, ...]
            const labels = data.map(row => row.Year);
            const revenue = data.map(row => parseFloat(row.Operating_Revenue));
            const expenses = data.map(row => parseFloat(row.Operating_Expenses));
            return { labels, revenue, expenses };
        }

        function processProjectionCSV(data) {
            // Assuming data is an array of objects like [{Year: "2025", Projected_Revenue: "120000", Projected_Operating_Costs: "60000"}, ...]
            const labels = data.map(row => row.Year);
            const revenue = data.map(row => parseFloat(row.Projected_Revenue));
            const costs = data.map(row => parseFloat(row.Projected_Operating_Costs));
            return { labels, revenue, costs };
        }

        function processCashFlowCSV(data) {
            // Assuming data is an array of objects like [{Year: "0", Cash_Flow: "-5000000"}, {Year: "1", Cash_Flow: "1000000"}, ...]
            return data.map(row => parseFloat(row.Cash_Flow));
        }

        // Function to navigate to a specific section and update navigation links
        function navigateToSection(sectionId) {
            // Hide all content sections, including intro
            document.querySelectorAll('#intro, #proposer-view > section, #committee-view > section, #memos-section-for-proposer-message, #memos, #schema').forEach(section => {
                section.classList.add('hidden');
            });

            // Show the requested section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                // For committee view, if navigating to #memos, ensure memoList is visible
                if (sectionId === 'memos' && window.userRole === 'committee') {
                    document.getElementById('memoList').parentElement.classList.remove('hidden');
                    document.getElementById('memoDetailView').classList.add('hidden');
                }
            } else {
                console.warn(`Section with ID '${sectionId}' not found.`);
            }

            // Update active class on navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${sectionId}`) {
                    link.classList.add('active');
                }
            });

            // Scroll to the selected section
            if (targetSection) {
                targetSection.scrollIntoView({ behavior: 'smooth' });
            }
        }


        // Main app initialization function, called after Firestore is ready or slider changes
        function updateRoleAndUI(roleValue) {
            window.userRole = (roleValue === 0) ? 'proposer' : 'committee';
            window.currentUserId = (roleValue === 0) ? 'proposer_simulated_user' : 'committee_simulated_user';
            authStatusEl.textContent = `Peran Saat Ini: ${window.userRole.charAt(0).toUpperCase() + window.userRole.slice(1)}`;

            // Hide all navigation links initially
            document.querySelectorAll('.nav-link').forEach(link => link.classList.add('hidden'));

            if (window.userRole === 'proposer') {
                document.getElementById('proposer-view').classList.remove('hidden');
                document.getElementById('committee-view').classList.add('hidden'); // Ensure committee view is hidden
                
                document.querySelector('a[href="#data-upload"]').classList.remove('hidden');
                document.querySelector('a[href="#lifecycle"]').classList.remove('hidden');
                document.querySelector('a[href="#components"]').classList.remove('hidden');
                document.querySelector('a[href="#evaluation"]').classList.remove('hidden');
                document.querySelector('a[href="#risk"]').classList.remove('hidden');
                document.querySelector('a[href="#memo-generation"]').classList.remove('hidden');
                document.querySelector('a[href="#schema"]').classList.remove('hidden');
                
                // Default to data upload section for proposer
                navigateToSection('data-upload'); 
            } else { // committee
                document.getElementById('committee-view').classList.remove('hidden');
                document.getElementById('proposer-view').classList.add('hidden'); // Ensure proposer view is hidden

                document.querySelector('a[href="#committee-dashboard"]').classList.remove('hidden');
                document.querySelector('a[href="#memos"]').classList.remove('hidden');
                document.querySelector('a[href="#schema"]').classList.remove('hidden'); // Committee might need schema reference

                // Default to committee dashboard for committee
                navigateToSection('committee-dashboard');
                updateCommitteeDashboard(); // Update dashboard counts
            }

            // Common initializations for both roles (charts, calculator, risk matrix setup)
            createOperatingAssetChart({ labels: [], revenue: [], expenses: [] });
            createProjectionChart({ labels: [], revenue: [], costs: [] });
            initCalculator([]);
            initRiskMatrix(); // This will initialize the proposer's risk matrix
            initTabs(); // Re-initialize tabs to ensure correct active state
            listenForMemos(); // This listener will populate the memo list for both roles, but only committee can interact.
        }

        // Event listener for role slider
        roleSlider.addEventListener('input', (event) => {
            updateRoleAndUI(parseInt(event.target.value));
        });

        // Add event listeners for navigation links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault(); // Prevent default anchor jump
                const sectionId = link.getAttribute('href').substring(1); // Get ID without '#'
                navigateToSection(sectionId);
            });
        });


        // Data Upload Logic (remains the same)
        document.getElementById('loadDataBtn').addEventListener('click', async () => {
            uploadStatusEl.textContent = 'Memuat data...';
            uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-blue-600';

            const operatingAssetFile = document.getElementById('operatingAssetCsv').files[0];
            const projectionFile = document.getElementById('projectionCsv').files[0];
            const cashflowFile = document.getElementById('cashflowCsv').files[0];

            let allLoaded = true;

            if (operatingAssetFile) {
                try {
                    const text = await operatingAssetFile.text();
                    // Store the raw parsed data, then process for chart
                    operatingAssetData = parseCSV(text); 
                    createOperatingAssetChart(processOperatingAssetCSV(operatingAssetData));
                } catch (error) {
                    uploadStatusEl.textContent = `Kesalahan memuat data Aset Operasional: ${error.message}`;
                    uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-red-600';
                    allLoaded = false;
                }
            } else {
                uploadStatusEl.textContent = 'CSV Aset Operasional tidak disediakan. Grafik akan kosong.';
                uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-orange-600';
                createOperatingAssetChart({ labels: [], revenue: [], expenses: [] });
            }

            if (projectionFile) {
                try {
                    const text = await projectionFile.text();
                    // Store the raw parsed data, then process for chart
                    projectionData = parseCSV(text); 
                    createProjectionChart(processProjectionCSV(projectionData));
                } catch (error) {
                    uploadStatusEl.textContent = `Kesalahan memuat data Proyeksi: ${error.message}`;
                    uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-red-600';
                    allLoaded = false;
                }
            } else {
                uploadStatusEl.textContent = 'CSV Proyeksi Keuangan tidak disediakan. Grafik akan kosong.';
                uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-orange-600';
                createProjectionChart({ labels: [], revenue: [], costs: [] });
            }

            if (cashflowFile) {
                try {
                    const text = await cashflowFile.text();
                    cashflowData = processCashFlowCSV(parseCSV(text));
                    initCalculator(cashflowData);
                } catch (error) {
                    uploadStatusEl.textContent = `Kesalahan memuat data Arus Kas: ${error.message}`;
                    uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-red-600';
                    allLoaded = false;
                }
            } else {
                uploadStatusEl.textContent = 'CSV Arus Kas tidak disediakan. Kalkulator akan kosong.';
                uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-orange-600';
                initCalculator([]);
            }

            if (allLoaded) {
                uploadStatusEl.textContent = 'Semua data berhasil dimuat! Anda sekarang dapat membuat Memo Investasi.';
                uploadStatusEl.className = 'md:col-span-2 lg:col-span-3 text-center text-sm mt-4 text-green-600';
                generateMemoBtn.disabled = false;
            } else {
                generateMemoBtn.disabled = true;
            }
        });

        // LLM Integration for Memo Generation (updated for Indonesian and error handling)
        generateMemoBtn.addEventListener('click', async () => {
            if (!operatingAssetData || !projectionData || !cashflowData) {
                memoGenerationStatusEl.textContent = 'Harap unggah semua data CSV yang diperlukan terlebih dahulu.';
                memoGenerationStatusEl.className = 'mt-4 text-sm text-red-600';
                return;
            }

            memoGenerationStatusEl.textContent = 'Membuat memo investasi... Ini mungkin membutuhkan waktu.';
            memoGenerationStatusEl.className = 'mt-4 text-sm text-blue-600';
            generateMemoBtn.disabled = true;
            sendForReviewBtn.disabled = true;

            // Get manual inputs
            const purposeText = memoPurposeInput.value.trim();
            const environmentalText = memoEnvironmentalInput.value.trim();
            const fiscalText = memoFiscalInput.value.trim();
            const operationalText = memoOperationalInput.value.trim();
            const legalText = memoLegalInput.value.trim();
            const riskManagementText = memoRiskManagementInput.value.trim();
            const governanceText = memoGovernanceInput.value.trim();
            const otherAspectsText = memoOtherAspectsInput.value.trim();

            // Prompt translated to Indonesian with new structure
            const prompt = `
            Hasilkan ringkasan memo investasi yang ringkas dan komprehensif untuk proyek Belanja Modal.
            Proyek ini melibatkan pembangunan "Pusat Distribusi Pantai Barat" dengan CapEx awal sebesar $5.000.000.
            
            Berikut adalah data dan kajian yang harus dimasukkan ke dalam memo:
            
            1. Finansial / Bisnis:
            Diisi sesuai dengan penjelasan pada kajian / lampiran e.g.: EBITDA Margin, Net Profit Margin, ROE, Current Ratio, Liquidity Buffer, IBD to Invested Capital, DSCR, Economic profit = invested capital x (ROIC-WACC), Nilai kelayakan ekonomi ( NPV > 0 , IRR > WACC dll), ROA.
            
            Data Finansial dari CSV:
            - Kinerja Historis Aset Operasional (Pendapatan, Beban per Tahun):
              Tahun: ${operatingAssetData.map(row => row.Year).join(', ')}
              Pendapatan: ${operatingAssetData.map(row => formatCurrency(parseFloat(row.Operating_Revenue))).join(', ')}
              Beban: ${operatingAssetData.map(row => formatCurrency(parseFloat(row.Operating_Expenses))).join(', ')}
            
            - Proyeksi Keuangan untuk Aset Baru (Pendapatan, Biaya per Tahun):
              Tahun: ${projectionData.map(row => row.Year).join(', ')}
              Pendapatan Proyeksi: ${projectionData.map(row => formatCurrency(parseFloat(row.Projected_Revenue))).join(', ')}
              Biaya Proyeksi: ${projectionData.map(row => formatCurrency(parseFloat(row.Projected_Operating_Costs))).join(', ')}
            
            - Arus Kas Proyek untuk Perhitungan NPV/IRR:
              Arus Kas: ${cashflowData.map(cf => formatCurrency(cf)).join(', ')} (Tahun 0 adalah investasi awal)
              NPV yang Dihitung: ${formatCurrency(currentNPV)}
              IRR yang Dihitung: ${(currentIRR * 100).toFixed(2)}%
            
            - Penilaian Risiko (Finansial):
              Peringkat Risiko Saat Ini: ${currentRiskRating} (${currentRiskCategory})
            
            2. Kepentingan / Objektivitas / Tujuan:
            ${purposeText || 'Tidak ada penjelasan yang diberikan.'}
            
            3. Lingkungan, Sosial, dan Ekonomi:
            Diisi Penjelasan singkat sesuai dengan penjelasan pada kajian aspek Sosial dan Ekonomi menunjukkan bahwa e.g.: Jumlah tenaga kerja yang dilibatkan, Kontribusi terhadap GDP, Dampak Lingkungan.
            Kajian: ${environmentalText || 'Tidak ada penjelasan yang diberikan.'}
            
            4. Fiskal:
            Diisi Penjelasan singkat sesuai dengan penjelasan pada kajian aspek Fiskal menunjukkan bahwa e.g.: Kontribusi Pajak Pemerintah Pusat/Daerah, Nilai kontribusi perusahaan sebagai agent of development ( kontribusi pajak dan PNBP sebesar Rp xxx,- , kontribusi Dividen sebesar Rp xxx,- dll), Besaran Insentif Pajak.
            Kajian: ${fiscalText || 'Tidak ada penjelasan yang diberikan.'}
            
            5. Pelayanan dan Operasional:
            Diisi sesuai dengan penjelasan pada kajian / lampiran e.g.: Menjaga skor CSI dengan target sebesar …, Downtime Operation (Serviceability Percentage), Length of Stay, Meminimalisasi Complain Resolution Rate, Peningkatan Jumlah Pengguna Jasa (Penumpang/Wisatawan/Visitor), Peningkatan Occupancy Rate, Pemenuhan 3S (Safety, Security, dan Services), Pemenuhan K3 (Kesehatan dan Keselamatan Kerja).
            Kajian: ${operationalText || 'Tidak ada penjelasan yang diberikan.'}
            
            6. Legal:
            Diisi sesuai dengan penjelasan pada kajian / lampiran e.g.: Analisa Hukum terkait Ketentuan Undang Undang Perseroan Terbatas, BUMN dan Ketentuan Internal Governance di Perusahaan (memuat analisa kewenangan Direksi member membuat keputusan untuk mengajukan usulan rencana), Analisa Hukum terkait Hubungan Hukum dengan Pihak Ketiga (jika ada), Analisa Pelaksanaan Fiduciary Duty Direksi Perusahaan (memuat analisa pelaksanaan FD atas pengajuan usulan rencana), Analisa Hukum terkait Lainnya (jika ada), Analisa Risiko Hukum dan Mitigasi (memuat risiko hukum dari semua analisa di atas, berikut dengan rekomendasi mitigasi).
            Kajian: ${legalText || 'Tidak ada penjelasan yang diberikan.'}
            
            7. Manajemen Risiko:
            Diisi sesuai dengan penjelasan pada kajian / lampiran e.g.: Nilai Eksposur Risiko, Biaya MItigasi Risiko.
            Kajian: ${riskManagementText || 'Tidak ada penjelasan yang diberikan.'}
            
            8. Corporate Governance & Compliance:
            Diisi sesuai dengan penjelasan pada kajian / lampiran e.g.: Penjelasan singkat terkait tingkat kepatuhan terhadap dokumen kelengkapan investasi/aksi korporasi dari Pengusul, Penjelasan singkat terkait tingkat kepatuhan internal.
            Kajian: ${governanceText || 'Tidak ada penjelasan yang diberikan.'}
            
            9. Aspek Lainnya:
            Dapat diusulkan parameter terkait aspek lainnya oleh Unit Terkait lainnya, e.g.: Meng-counter Sentimen Pemberitaan, Pemenuhan SLA untuk IT Maturity, SDM.
            Kajian: ${otherAspectsText || 'Tidak ada penjelasan yang diberikan.'}
            
            Format output harus berupa memo yang terstruktur dengan judul bagian yang jelas untuk setiap aspek di atas.
            `;

            try {
                const chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // Canvas will provide this
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                console.log("Sending API request with payload:", payload); // Log payload
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorBody = await response.json();
                    const errorMessage = errorBody.error ? errorBody.error.message : 'Unknown API error';
                    memoGenerationStatusEl.textContent = `Failed to generate memo: ${errorMessage}`;
                    memoGenerationStatusEl.className = 'mt-4 text-sm text-red-600';
                    console.error("API Error Response:", errorBody);
                    return; // Exit if response is not OK
                }

                const result = await response.json();
                console.log("Successful API response:", result); // Log successful response

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    memoContentEl.textContent = text;
                    generatedMemoDisplayEl.classList.remove('hidden');
                    memoGenerationStatusEl.textContent = 'Memo investasi berhasil dibuat!';
                    memoGenerationStatusEl.className = 'mt-4 text-sm text-green-600';
                    sendForReviewBtn.disabled = false;
                } else {
                    memoGenerationStatusEl.textContent = 'Gagal membuat memo. Struktur respons API tidak terduga.';
                    memoGenerationStatusEl.className = 'mt-4 text-sm text-red-600';
                    console.error("Unexpected API response structure:", result);
                }
            } catch (error) {
                console.error("Error generating memo:", error);
                memoGenerationStatusEl.textContent = `Kesalahan saat membuat memo: ${error.message}`;
                memoGenerationStatusEl.className = 'mt-4 text-sm text-red-600';
            } finally {
                generateMemoBtn.disabled = false;
            }
        });

        // Send Memo for Review (Firestore Save) (remains the same)
        sendForReviewBtn.addEventListener('click', async () => {
            if (!memoContentEl.textContent) {
                memoGenerationStatusEl.textContent = 'Tidak ada konten memo untuk dikirim.';
                memoGenerationStatusEl.className = 'mt-4 text-sm text-red-600';
                return;
            }

            sendForReviewBtn.disabled = true;
            memoGenerationStatusEl.textContent = 'Mengirim memo untuk ditinjau...';
            memoGenerationStatusEl.className = 'mt-4 text-sm text-blue-600';

            try {
                const memosCollectionRef = collection(db, `artifacts/${appId}/public/data/investmentMemos`);
                const reviewDeadline = new Date();
                reviewDeadline.setDate(reviewDeadline.getDate() + 3); // 3 days from now

                await addDoc(memosCollectionRef, {
                    title: `Memo Investasi - Proyek: Pusat Distribusi Pantai Barat (${new Date().toLocaleDateString('id-ID')})`,
                    content: memoContentEl.textContent,
                    authorId: window.currentUserId, // Use global currentUserId
                    status: 'Menunggu Peninjauan',
                    submittedAt: serverTimestamp(),
                    reviewDeadline: reviewDeadline.toISOString(), // Store as ISO string
                    // Store key metrics for easy reference
                    npv: currentNPV,
                    irr: currentIRR,
                    riskRating: currentRiskRating,
                    riskCategory: currentRiskCategory
                });

                memoGenerationStatusEl.textContent = 'Memo berhasil dikirim untuk ditinjau!';
                memoGenerationStatusEl.className = 'mt-4 text-sm text-green-600';
                generatedMemoDisplayEl.classList.add('hidden'); // Hide generated memo after sending
            } catch (error) {
                console.error("Error sending memo for review:", error);
                memoGenerationStatusEl.textContent = `Kesalahan saat mengirim memo untuk ditinjau: ${error.message}`;
                memoGenerationStatusEl.className = 'mt-4 text-sm text-red-600';
            } finally {
                sendForReviewBtn.disabled = false;
            }
        });

        // Listener for Investment Memos (remains the same, but now updates committee dashboard)
        function listenForMemos() {
            const memosCollectionRef = window.firebaseCollection(db, `artifacts/${appId}/public/data/investmentMemos`);
            window.firebaseOnSnapshot(memosCollectionRef, (snapshot) => {
                memoListEl.innerHTML = '';
                let pendingCount = 0; // Track pending memos for dashboard
                if (snapshot.empty) {
                    memoListEl.innerHTML = '<p class="text-slate-500">Tidak ada memo yang tersedia untuk ditinjau.</p>';
                    document.getElementById('pendingMemosCount').textContent = 0;
                    document.getElementById('pendingMemosCountMessage').textContent = 0;
                    return;
                }

                const memos = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    memos.push({ id: doc.id, ...data });
                });

                // Sort memos by submittedAt, newest first
                memos.sort((a, b) => (b.submittedAt?.toDate() || 0) - (a.submittedAt?.toDate() || 0));

                memos.forEach(memo => {
                    const memoDate = memo.submittedAt ? memo.submittedAt.toDate().toLocaleDateString('id-ID') : 'N/A';
                    const deadlineDate = new Date(memo.reviewDeadline);
                    const now = new Date();
                    let statusText = memo.status;
                    let statusClass = '';

                    if (memo.status === 'Menunggu Peninjauan' && now > deadlineDate) {
                        statusText = 'Terlambat - Komentar Dikirim ke Anak Perusahaan (Disimulasikan)';
                        statusClass = 'memo-status-overdue';
                        // Simulate automatic sending if not already marked
                        // In a real app, this would trigger a server-side function
                        // For this demo, we just update the status text and class
                    } else if (memo.status === 'Menunggu Peninjauan') {
                        statusText = 'Menunggu Peninjauan';
                        statusClass = 'memo-status-pending';
                        pendingCount++; // Increment pending count
                    } else if (memo.status === 'Ditinjau') {
                        statusText = 'Ditinjau';
                        statusClass = 'memo-status-reviewed';
                    }

                    const memoCard = document.createElement('div');
                    memoCard.className = `p-4 border rounded-lg shadow-sm cursor-pointer hover:bg-slate-50 transition-colors ${statusClass}`;
                    memoCard.innerHTML = `
                        <h5 class="font-semibold text-slate-800">${memo.title}</h5>
                        <p class="text-sm text-slate-600">Dikirim: ${memoDate} oleh ${memo.authorId}</p>
                        <p class="text-sm text-slate-600">Status: <span class="font-bold">${statusText}</span> | Batas Waktu: ${deadlineDate.toLocaleDateString('id-ID')}</p>
                    `;
                    memoCard.addEventListener('click', () => showMemoDetail(memo.id));
                    memoListEl.appendChild(memoCard);
                });

                // Update committee dashboard counts
                if (window.userRole === 'committee') { // Use global userRole
                    document.getElementById('pendingMemosCount').textContent = pendingCount;
                    document.getElementById('pendingMemosCountMessage').textContent = pendingCount;
                }

            }, (error) => {
                console.error("Error listening for memos:", error);
                memoListEl.innerHTML = `<p class="text-red-600">Kesalahan saat memuat memo: ${error.message}</p>`;
            });
        }

        // Show Memo Detail View (remains the same)
        async function showMemoDetail(memoId) {
            currentMemoId = memoId;
            memoListEl.parentElement.classList.add('hidden'); // Hide memo list
            memoDetailViewEl.classList.remove('hidden'); // Show detail view

            const memoRef = window.firebaseDoc(db, `artifacts/${appId}/public/data/investmentMemos`, memoId);
            const memoSnap = await window.firebaseGetDoc(memoRef);

            if (memoSnap.exists()) {
                const memo = memoSnap.data();
                memoDetailTitleEl.textContent = memo.title;
                memoDetailContentEl.textContent = memo.content;
                memoDetailAuthorEl.textContent = memo.authorId;
                memoDetailDeadlineEl.textContent = new Date(memo.reviewDeadline).toLocaleDateString('id-ID');

                const now = new Date();
                const deadlineDate = new Date(memo.reviewDeadline);
                let statusText = memo.status;
                let statusClass = '';

                if (memo.status === 'Menunggu Peninjauan' && now > deadlineDate) {
                    statusText = 'Terlambat - Komentar Dikirim ke Anak Perusahaan (Disimulasikan)';
                    statusClass = 'memo-status-overdue';
                } else if (memo.status === 'Menunggu Peninjauan') {
                    statusText = 'Menunggu Peninjauan';
                    statusClass = 'memo-status-pending';
                } else if (memo.status === 'Ditinjau') {
                    statusText = 'Ditinjau';
                    statusClass = 'memo-status-reviewed';
                }
                memoDetailStatusEl.textContent = statusText;
                memoDetailStatusEl.className = `font-semibold ${statusClass}`;

                // Only allow commenting and marking as reviewed if pending, not overdue, AND user is committee member
                if (window.userRole === 'committee' && memo.status === 'Menunggu Peninjauan' && now <= deadlineDate) { // Use global userRole
                    commentInputEl.disabled = false;
                    addCommentBtn.disabled = false;
                    markAsReviewedBtn.disabled = false;
                } else {
                    commentInputEl.disabled = true;
                    addCommentBtn.disabled = true;
                    markAsReviewedBtn.disabled = true;
                }

                listenForComments(memoId); // Start listening for comments for this memo
            } else {
                memoDetailTitleEl.textContent = 'Memo Tidak Ditemukan';
                memoDetailContentEl.textContent = '';
                commentsListEl.innerHTML = '<p class="text-red-600">Memo tidak ditemukan.</p>';
            }
        }

        // Listen for Comments (remains the same)
        function listenForComments(memoId) {
            const commentsCollectionRef = window.firebaseCollection(db, `artifacts/${appId}/public/data/memoComments`);
            const q = window.firebaseQuery(commentsCollectionRef, window.firebaseWhere("memoId", "==", memoId));
            window.firebaseOnSnapshot(q, (snapshot) => {
                commentsListEl.innerHTML = '';
                if (snapshot.empty) {
                    commentsListEl.innerHTML = '<p class="text-slate-500">Belum ada komentar.</p>';
                    return;
                }

                const comments = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    comments.push({ id: doc.id, ...data });
                });

                // Sort comments by timestamp, oldest first
                comments.sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));

                comments.forEach(comment => {
                    const commentDate = comment.timestamp ? comment.timestamp.toDate().toLocaleString('id-ID') : 'N/A';
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'p-3 bg-white rounded-md shadow-sm border border-slate-200';
                    commentDiv.innerHTML = `
                        <p class="text-sm text-slate-800">${comment.commentText}</p>
                        <p class="text-xs text-slate-500 mt-1">Komentar oleh ${comment.reviewerId} pada ${commentDate}</p>
                    `;
                    commentsListEl.appendChild(commentDiv);
                });
            }, (error) => {
                console.error("Error listening for comments:", error);
                commentsListEl.innerHTML = `<p class="text-red-600">Kesalahan saat memuat komentar: ${error.message}</p>`;
            });
        }

        // Add Comment (remains the same, but now disabled for non-committee)
        addCommentBtn.addEventListener('click', async () => {
            const commentText = commentInputEl.value.trim();
            if (!commentText || !currentMemoId || !window.currentUserId || window.userRole !== 'committee') { // Use global currentUserId and userRole
                displayMessage('Anda tidak diizinkan untuk menambahkan komentar.', 'error');
                return;
            }

            addCommentBtn.disabled = true;
            try {
                const commentsCollectionRef = window.firebaseCollection(db, `artifacts/${appId}/public/data/memoComments`);
                await window.firebaseAddDoc(commentsCollectionRef, {
                    memoId: currentMemoId,
                    reviewerId: window.currentUserId, // Use global currentUserId
                    commentText: commentText,
                    timestamp: serverTimestamp()
                });
                commentInputEl.value = ''; // Clear input
                displayMessage('Komentar berhasil ditambahkan!', 'success');
            } catch (error) {
                console.error("Error adding comment:", error);
                displayMessage(`Kesalahan saat menambahkan komentar: ${error.message}`, 'error');
            } finally {
                addCommentBtn.disabled = false;
            }
        });

        // Mark Memo as Reviewed (remains the same, but now disabled for non-committee)
        markAsReviewedBtn.addEventListener('click', async () => {
            if (!currentMemoId || window.userRole !== 'committee') { // Use global userRole
                displayMessage('Anda tidak diizinkan untuk menandai memo sebagai ditinjau.', 'error');
                return;
            }

            markAsReviewedBtn.disabled = true;
            try {
                const memoRef = window.firebaseDoc(db, `artifacts/${appId}/public/data/investmentMemos`, currentMemoId);
                await window.firebaseUpdateDoc(memoRef, {
                    status: 'Ditinjau',
                    reviewedBy: window.currentUserId, // Use global currentUserId
                    reviewedAt: serverTimestamp()
                });
                displayMessage('Memo ditandai sebagai ditinjau!', 'success');
                // Refresh detail view to show new status
                showMemoDetail(currentMemoId);
            } catch (error) {
                console.error("Error marking memo as reviewed:", error);
                displayMessage(`Kesalahan saat menandai memo sebagai ditinjau: ${error.message}`, 'error');
            } finally {
                markAsReviewedBtn.disabled = false;
            }
        });

        // Back to Memo List (remains the same)
        backToMemoListBtn.addEventListener('click', () => {
            memoDetailViewEl.classList.add('hidden');
            memoListEl.parentElement.classList.remove('hidden');
            currentMemoId = null; // Clear current memo context
        });

        // Update Committee Dashboard (new function, called by listenForMemos)
        function updateCommitteeDashboard() {
            // This function is called by listenForMemos, which already calculates pendingCount
            // The pendingMemosCount and pendingMemosCountMessage elements are updated directly
            // within listenForMemos.
        }

        // Custom Message Box (not alert) (remains the same)
        function displayMessage(message, type) {
            const messageBox = document.createElement('div');
            messageBox.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white z-50`;
            if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.add('bg-blue-500');
            }
            messageBox.textContent = message;
            document.body.appendChild(messageBox);
            setTimeout(() => {
                messageBox.remove();
            }, 3000); // Remove after 3 seconds
        }

        // Improved parseCSV function
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.trim());
                const obj = {};
                headers.forEach((header, i) => {
                    obj[header] = values[i];
                });
                return obj;
            });
        }

        // Initial initialization for components that don't depend on immediate authentication
        initTabs(); // Tabs can be initialized earlier as their content is static schema.
    </script>
</body>
</html>
